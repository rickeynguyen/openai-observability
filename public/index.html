<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>OpenAI Status (Lite OTel)</title>
    <style>
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0b0f14;color:#d9e1ea;margin:0;padding:24px}
      h1{font-size:20px;margin:0 0 16px}
      .row{display:flex;gap:16px;flex-wrap:wrap}
      .card{background:#111827;border:1px solid #243244;border-radius:12px;padding:16px;min-width:260px;flex:1}
      .k{color:#93c5fd}.v{color:#e5e7eb}.ok{color:#34d399}.bad{color:#fb7185}
      table{width:100%;border-collapse:collapse}td,th{border-bottom:1px solid #1f2937;padding:6px 8px;text-align:left;font-size:13px}
      .muted{color:#9ca3af}.pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#1f2937}
  .badge-default{display:inline-block;margin-left:6px;padding:2px 6px;border-radius:6px;background:#334155;color:#93c5fd;font-size:10px;font-weight:600;letter-spacing:.5px;text-transform:uppercase;border:1px solid #475569}
      footer{margin-top:32px;font-size:12px;color:#6b7280}
      th[data-k]{cursor:pointer}
  /* High-contrast nav buttons */
  .nav-btn{cursor:pointer;display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;background:#1e293b;border:1px solid #334155;color:#e5e7eb;font-size:12px}
  .nav-btn:hover{background:#2a3a51;border-color:#3b4a63}
  .nav-btn.active{background:#3b82f6;border-color:#2563eb;color:#ffffff}
  /* App buttons (high-contrast) */
  .btn{cursor:pointer;display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:6px;background:#1e293b;border:1px solid #334155;color:#e5e7eb;font-size:12px}
  .btn:hover{background:#2a3a51;border-color:#3b4a63}
  .btn-primary{background:#2563eb;border-color:#1d4ed8;color:#ffffff}
  .btn-primary:hover{background:#1e50c5;border-color:#1a47b1}
  .btn-danger{background:#b91c1c;border-color:#991b1b;color:#ffffff}
  .btn-danger:hover{background:#991b1b;border-color:#7f1d1d}
  .btn-accent{background:#7c3aed;border-color:#6d28d9;color:#ffffff}
  .btn-accent:hover{background:#6d28d9;border-color:#5b21b6}
  /* Minimal markdown styling scoped to answer/narrative */
  #chatAnswer, #chatNarrative { white-space: normal; }
  #chatAnswer h1,#chatAnswer h2,#chatAnswer h3,#chatAnswer h4,#chatAnswer h5,#chatAnswer h6{margin:6px 0 4px;font-weight:700}
  #chatAnswer p{margin:6px 0}
  #chatAnswer ul,#chatAnswer ol{margin:6px 0 6px 18px}
  #chatAnswer li{margin:2px 0}
  #chatAnswer code{background:#0f172a;border:1px solid #243244;padding:0 4px;border-radius:4px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px}
  #chatAnswer pre{background:#0f172a;border:1px solid #243244;padding:8px;border-radius:6px;overflow:auto}
  #chatAnswer pre code{border:none;padding:0}
  #chatAnswer a{color:#93c5fd;text-decoration:underline}
  #chatAnswer blockquote{border-left:3px solid #334155;margin:6px 0;padding:4px 8px;background:#0f172a}
  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
  </head>
  <body>
  <h1 style="display:flex;flex-wrap:wrap;gap:12px;align-items:center">OpenAI Status (Lite OTel) <span id="since" class="muted"></span>
      <span style="flex:1 1 auto"></span>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <label class="muted" style="font-size:12px;display:flex;align-items:center;gap:4px">Preset:
          <select id="windowSelect" style="background:#111827;color:#e5e7eb;border:1px solid #243244;border-radius:6px;padding:4px 6px;font-size:12px">
            <option value="15">15m</option><option value="30">30m</option><option value="60" selected>60m</option><option value="180">3h</option><option value="720">12h</option><option value="1440">24h</option><option value="4320">3d</option><option value="10080">7d</option><option value="20160">14d</option><option value="43200">30d</option><option value="129600">90d</option>
          </select>
        </label>
        <label class="muted" style="font-size:12px;display:flex;align-items:center;gap:4px">Probe interval:
          <select id="probeIntervalSelect" style="background:#111827;color:#e5e7eb;border:1px solid #243244;border-radius:6px;padding:4px 6px;font-size:12px">
            <option value="60">60s</option>
            <option value="300">5m</option>
            <option value="600">10m</option>
            <option value="900">15m</option>
          </select>
        </label>
  <label class="muted" style="font-size:12px;display:flex;align-items:center;gap:6px"><input id="useCustomRange" type="checkbox" /> Use custom range</label>
  <label class="muted" style="font-size:12px;display:flex;flex-direction:column;gap:2px"><span>From:</span><input id="fromTs" type="datetime-local" style="background:#111827;color:#e5e7eb;border:1px solid #243244;border-radius:6px;padding:4px 6px;font-size:12px" /></label>
  <label class="muted" style="font-size:12px;display:flex;flex-direction:column;gap:2px"><span>To:</span><input id="toTs" type="datetime-local" style="background:#111827;color:#e5e7eb;border:1px solid #243244;border-radius:6px;padding:4px 6px;font-size:12px" /></label>
        <button id="applyRange" style="background:#2563eb;border:1px solid #1d4ed8;color:#e5e7eb;border-radius:6px;padding:4px 10px;font-size:12px;cursor:pointer">Apply</button>
        <label class="muted" style="font-size:12px;display:flex;align-items:center;gap:4px">Endpoint:
          <select id="endpointFilter" size="1" style="min-width:200px;background:#111827;color:#e5e7eb;border:1px solid #243244;border-radius:6px;padding:4px 6px;font-size:12px"></select>
        </label>
        <button id="exportCsv" style="background:#1f2937;border:1px solid #243244;color:#e5e7eb;border-radius:6px;padding:4px 10px;font-size:12px;cursor:pointer">CSV</button>
        <button id="exportJson" style="background:#1f2937;border:1px solid #243244;color:#e5e7eb;border-radius:6px;padding:4px 10px;font-size:12px;cursor:pointer">JSON</button>
      </div>
    </h1>
  <div style="display:flex;gap:12px;margin-top:8px;align-items:center"><button id="viewSummary" class="nav-btn active">Summary</button><button id="viewTraces" class="nav-btn">Traces</button><button id="viewChat" class="nav-btn">Chat</button><button id="viewSynthetics" class="nav-btn">Synthetics</button><button id="createSyntheticBtn" class="nav-btn" title="Create synthetic monitor using AI">Create Synthetic</button><span id="lastRefresh" class="muted" style="margin-left:auto;font-size:11px"></span></div>
    <div class="row" id="cards"></div>
    <!-- Enhancements (visible with Summary view) -->
    <section id="enhancements" style="display:block;margin-top:16px">
      <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:12px; font-size:12px">
        <label>Compare:
          <select id="cmpSelect" style="background:#111827;color:#e5e7eb;border:1px solid #243244;border-radius:6px;padding:4px 6px;">
            <option value="none">None</option>
            <option value="model">Model</option>
            <option value="region">Region</option>
            <option value="baseline">Baseline vs Canary</option>
          </select>
        </label>
        <span id="cmpValuesContainer" style="display:none; gap:8px; align-items:center;">
          <label id="cmpValuesLabel">Values:</label>
          <select id="cmpValues" multiple size="3" style="min-width:200px;background:#111827;color:#e5e7eb;border:1px solid #243244;border-radius:6px;padding:4px 6px;"></select>
        </span>
        <span id="baselineCanaryControls" style="display:none; gap:8px; align-items:center;">
          <button id="saveBaselineBtn" type="button" class="pill" style="cursor:pointer">Save Baseline</button>
          <button id="saveCanaryBtn" type="button" class="pill" style="cursor:pointer">Save Canary</button>
        </span>
        <span style="margin-left:24px; display:flex; gap:6px; align-items:center">
          <label>SLO target:
            <select id="sloTargetSelect" style="background:#111827;color:#e5e7eb;border:1px solid #243244;border-radius:6px;padding:4px 6px;">
              <option value="0.99">99.0%</option>
              <option value="0.995" selected>99.5%</option>
              <option value="0.999">99.9%</option>
              <option value="custom">Custom</option>
            </select>
          </label>
          <input id="sloTargetCustom" type="number" step="0.0001" min="0.90" max="0.9999" placeholder="0.997" style="width:90px;background:#111827;color:#e5e7eb;border:1px solid #243244;border-radius:6px;padding:4px 6px; display:none;">
        </span>
        <label style="margin-left:auto;display:flex;gap:6px;align-items:center"><input id="toggleIncidents" type="checkbox" checked> Show incidents</label>
      </div>

      <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px; font-size:12px">
        <div class="card" style="min-width:220px;">
          <div style="font-weight:600;">Current SLI</div>
          <div id="sliValue" style="font-size:20px; margin-top:6px;">—</div>
          <div id="sliMeta" class="muted" style="margin-top:4px;">target: —</div>
        </div>
        <div class="card" style="min-width:260px;">
          <div style="font-weight:600;">Error Budget Remaining</div>
          <div id="ebrValue" style="font-size:20px; margin-top:6px;">—</div>
          <div style="background:#0f172a; height:8px; border-radius:4px; margin-top:8px; position:relative;border:1px solid #243244;">
            <div id="ebrBar" style="background:#34d399; height:8px; border-radius:4px; width:0%;"></div>
          </div>
          <div id="ebrMeta" class="muted" style="margin-top:4px;">spent: —</div>
        </div>
        <div class="card" style="flex:1; min-width:300px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:600;">Burn-rate Sparkline</div>
            <div id="burnRateLegend" class="muted"></div>
          </div>
          <canvas id="burnRateSpark" height="60" style="width:100%;"></canvas>
        </div>
      </div>

      <div class="card" style="margin-bottom:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div style="font-weight:600;">Latency percentiles over time</div>
          <div id="latencyLegend" class="muted">p50 / p95</div>
        </div>
        <div style="position:relative;">
          <canvas id="latencyTimeseries" height="160" style="width:100%;"></canvas>
          <canvas id="incidentOverlay" height="160" style="width:100%; position:absolute; left:0; top:0; pointer-events:none;"></canvas>
        </div>
      </div>

      <div class="row" style="margin-bottom:12px;">
        <div class="card" style="flex:1;">
          <div style="font-weight:600; margin-bottom:6px;">Latency percentile heatmap</div>
          <canvas id="latencyHeatmap" height="180" style="width:100%;"></canvas>
        </div>
        <div class="card" style="flex:1;">
          <div style="font-weight:600; margin-bottom:6px;">Error heatmap (status/errType)</div>
          <canvas id="errorHeatmap" height="180" style="width:100%;"></canvas>
        </div>
      </div>

      <div class="card" style="margin-bottom:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div style="font-weight:600;">Cost and tokens over time (approximate)</div>
          <div id="costLegend" class="muted">Stacked tokens + $ line</div>
        </div>
        <canvas id="tokensArea" height="120" style="width:100%;"></canvas>
        <canvas id="costLine" height="80" style="width:100%;"></canvas>
        <div id="costCompareSummary" class="muted" style="margin:6px 0; display:none;"></div>
        <div id="costCompareContainer" style="display:none; gap:12px; align-items:flex-start;">
          <div style="flex:1; overflow:auto; max-height:240px;">
            <div class="muted" style="margin:4px 0">Baseline</div>
            <table id="costTableBaseline" style="width:100%; border-collapse:collapse; font-size:12px;">
              <thead>
                <tr>
                  <th style="text-align:left; border-bottom:1px solid #243244; padding:6px;">Endpoint</th>
                  <th style="text-align:left; border-bottom:1px solid #243244; padding:6px;">Model</th>
                  <th style="text-align:right; border-bottom:1px solid #243244; padding:6px;">Prompt tokens</th>
                  <th style="text-align:right; border-bottom:1px solid #243244; padding:6px;">Completion tokens</th>
                  <th style="text-align:right; border-bottom:1px solid #243244; padding:6px;">Total tokens</th>
                  <th style="text-align:right; border-bottom:1px solid #243244; padding:6px;">Approx $</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div style="flex:1; overflow:auto; max-height:240px;">
            <div class="muted" style="margin:4px 0">Canary</div>
            <table id="costTableCanary" style="width:100%; border-collapse:collapse; font-size:12px;">
              <thead>
                <tr>
                  <th style="text-align:left; border-bottom:1px solid #243244; padding:6px;">Endpoint</th>
                  <th style="text-align:left; border-bottom:1px solid #243244; padding:6px;">Model</th>
                  <th style="text-align:right; border-bottom:1px solid #243244; padding:6px;">Prompt tokens</th>
                  <th style="text-align:right; border-bottom:1px solid #243244; padding:6px;">Completion tokens</th>
                  <th style="text-align:right; border-bottom:1px solid #243244; padding:6px;">Total tokens</th>
                  <th style="text-align:right; border-bottom:1px solid #243244; padding:6px;">Approx $</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div style="overflow:auto; max-height:240px; margin-top:8px;">
      <table id="costBreakdownTable" style="width:100%; border-collapse:collapse; font-size:12px;">
            <thead>
              <tr>
        <th style="text-align:left; border-bottom:1px solid #243244; padding:6px;">Endpoint</th>
        <th style="text-align:left; border-bottom:1px solid #243244; padding:6px;">Model</th>
        <th style="text-align:right; border-bottom:1px solid #243244; padding:6px;">Prompt tokens</th>
        <th style="text-align:right; border-bottom:1px solid #243244; padding:6px;">Completion tokens</th>
        <th style="text-align:right; border-bottom:1px solid #243244; padding:6px;">Total tokens</th>
        <th style="text-align:right; border-bottom:1px solid #243244; padding:6px;">Approx $</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
    <div id="tracesContainer" style="display:none;margin-top:16px">
      <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:8px;font-size:12px">
        <label class="muted" style="display:flex;align-items:center;gap:4px"><input type="checkbox" id="errorsOnly"/> Errors only</label>
        <label class="muted" style="display:flex;align-items:center;gap:4px">Slow >= <input type="number" id="slowMs" min="0" placeholder="ms" style="width:70px;background:#111827;color:#e5e7eb;border:1px solid #243244;border-radius:4px;padding:2px 4px;font-size:12px"/></label>
        <button id="applyTraceFilters" style="background:#1f2937;border:1px solid #243244;color:#e5e7eb;border-radius:6px;padding:4px 10px;font-size:12px;cursor:pointer">Apply Filters</button>
        <div style="margin-left:auto;display:flex;gap:6px;align-items:center">
          <button id="prevPage" disabled style="background:#1f2937;border:1px solid #243244;color:#e5e7eb;border-radius:6px;padding:4px 8px;font-size:12px;cursor:pointer">Prev</button>
          <button id="nextPage" disabled style="background:#1f2937;border:1px solid #243244;color:#e5e7eb;border-radius:6px;padding:4px 8px;font-size:12px;cursor:pointer">Next</button>
          <button id="exportTraceCsv" style="background:#1f2937;border:1px solid #243244;color:#e5e7eb;border-radius:6px;padding:4px 8px;font-size:12px;cursor:pointer">Trace CSV</button>
          <button id="exportTraceJson" style="background:#1f2937;border:1px solid #243244;color:#e5e7eb;border-radius:6px;padding:4px 8px;font-size:12px;cursor:pointer">Trace JSON</button>
          <button id="exportTraceAllCsv" style="background:#1f2937;border:1px solid #243244;color:#e5e7eb;border-radius:6px;padding:4px 8px;font-size:12px;cursor:pointer">All CSV</button>
          <button id="exportTraceAllJson" style="background:#1f2937;border:1px solid #243244;color:#e5e7eb;border-radius:6px;padding:4px 8px;font-size:12px;cursor:pointer">All JSON</button>
        </div>
      </div>
      <div style="overflow:auto;max-height:60vh;border:1px solid #243244;border-radius:8px">
        <table id="tracesTable" style="width:100%;font-size:12px">
          <thead style="position:sticky;top:0;background:#111827"><tr id="traceHeaderRow"><th data-k="iso">Time (UTC)</th><th data-k="status">Status</th><th data-k="ok">OK</th><th data-k="latencyMs">Latency(ms)</th><th data-k="endpoint">Endpoint</th><th data-k="model">Model</th><th data-k="region">Region</th><th data-k="errType">Error</th><th data-k="tokensTotal">Tokens</th><th data-k="respBytes">Resp Bytes</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="traceMeta" class="muted" style="margin-top:6px;font-size:11px"></div>
    </div>
    <!-- Synthetics Tab -->
    <div id="syntheticsContainer" style="display:none;margin-top:16px">
      <div class="row">
        <div class="card" style="flex:1; min-width:300px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
            <div style="font-weight:600;">Monitors</div>
            <button id="refreshSynthMonitors" class="btn" type="button">Refresh</button>
            <label style="display:flex;align-items:center;gap:4px;font-size:11px;">
              <input type="checkbox" id="showDeletedSynth" style="margin:0;"> <span class="muted">Show deleted</span>
            </label>
          </div>
          <div style="overflow:auto; max-height:40vh;">
    <table id="synthMonitorsTable" style="width:100%; border-collapse:collapse; font-size:12px;">
              <thead>
                <tr>
                  <th style="text-align:left; border-bottom:1px solid #243244; padding:6px;">ID</th>
                  <th style="text-align:left; border-bottom:1px solid #243244; padding:6px;">Name</th>
      <th style="text-align:left; border-bottom:1px solid #243244; padding:6px;">Schedule</th>
                  <th style="text-align:left; border-bottom:1px solid #243244; padding:6px;">Last run</th>
                  <th style="text-align:left; border-bottom:1px solid #243244; padding:6px;">Next run</th>
                  <th style="text-align:left; border-bottom:1px solid #243244; padding:6px;">Countdown</th>
                  <th style="text-align:left; border-bottom:1px solid #243244; padding:6px;">Created</th>
                  <th style="text-align:left; border-bottom:1px solid #243244; padding:6px;">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="card" style="flex:1; min-width:300px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
            <div style="font-weight:600;">Recent Runs</div>
            <button id="refreshSynthRuns" class="btn" type="button">Refresh</button>
          </div>
          <div style="overflow:auto; max-height:40vh;">
            <table id="synthRunsTable" style="width:100%; border-collapse:collapse; font-size:12px;">
              <thead>
                <tr>
                  <th style="text-align:left; border-bottom:1px solid #243244; padding:6px;">Run</th>
                  <th style="text-align:left; border-bottom:1px solid #243244; padding:6px;">Monitor</th>
                  <th style="text-align:left; border-bottom:1px solid #243244; padding:6px;">Started</th>
                  <th style="text-align:left; border-bottom:1px solid #243244; padding:6px;">Status</th>
                  <th style="text-align:left; border-bottom:1px solid #243244; padding:6px;">Screenshot</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <!-- Chat Tab -->
    <div id="chatContainer" style="display:none;margin-top:16px">
      <div class="card" style="margin-bottom:12px;">
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px;font-size:12px">
          <button id="chatToggleSim" class="btn btn-primary" type="button">Start log simulator</button>
          <button id="chatToggleIndex" class="btn btn-accent" type="button">Enable auto-index</button>
          <span class="muted">Uses current endpoint and time range</span>
          <span id="simAutoNotice" class="muted" style="display:none; padding:2px 6px; border:1px solid #334155; border-radius:6px; background:#0f172a;">Simulator auto-start is enabled by server config</span>
          <span id="simAutoStatus" class="muted" style="display:none; padding:2px 6px; border:1px solid #334155; border-radius:6px; background:#0f172a;"></span>
          <span style="margin-left:auto; display:flex; gap:6px; align-items:center;">
            <label class="muted">Ingest key:</label>
            <input id="chatKey" type="password" placeholder="x-api-key (default: secret)" style="width:180px;background:#111827;color:#e5e7eb;border:1px solid #243244;border-radius:6px;padding:4px 6px;" />
          </span>
          <span id="chatOpsMsg" class="muted"></span>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px;font-size:12px">
          <label>Reason:
            <select id="chatReason" style="background:#111827;color:#e5e7eb;border:1px solid #243244;border-radius:6px;padding:4px 6px;min-width:220px">
              <option value="" selected>Select a reason…</option>
              <option value="triage">Triage an incident</option>
              <option value="correlate">Correlate an issue</option>
              <option value="rca">Root cause analysis</option>
              <option value="visualize">Create a visualization</option>
              <option value="cost">Analyze a cost spike</option>
              <option value="perf">Performance regression</option>
              <option value="anomaly">Error burst / anomaly detection</option>
              <option value="security">Audit / security check</option>
              <option value="usage">Usage trends</option>
              <option value="canary">Baseline vs Canary compare</option>
            </select>
          </label>
          <label>Templates:
            <select id="chatTemplates" style="background:#111827;color:#e5e7eb;border:1px solid #243244;border-radius:6px;padding:4px 6px;min-width:320px">
              <option value="" selected>Pick a prompt template…</option>
            </select>
          </label>
          <label>Model:
            <select id="chatModel" style="background:#111827;color:#e5e7eb;border:1px solid #243244;border-radius:6px;padding:4px 6px;min-width:200px">
              <option value="">(default)</option>
            </select>
          </label>
          <label style="display:flex; gap:6px; align-items:center;">
            <input id="chatUseLlm" type="checkbox" /> Use LLM
          </label>
          <!-- Removed deprecated Replace Answer with LLM checkbox (superseded by upcoming Summary|Narrative tabs) -->
          <span class="muted">Tip: templates and reasons pre-fill the box; edit before sending.</span>
        </div>
        <div style="display:flex;gap:8px;align-items:flex-start;">
          <textarea id="chatInput" rows="3" placeholder="Ask about reliability, errors, costs…" style="flex:1;background:#111827;color:#e5e7eb;border:1px solid #243244;border-radius:6px;padding:8px;font-size:13px"></textarea>
          <div style="display:flex;flex-direction:column;gap:8px;align-items:stretch;">
            <button id="chatSend" style="background:#2563eb;border:1px solid #1d4ed8;color:#e5e7eb;border-radius:6px;padding:8px 12px;font-size:13px;cursor:pointer;min-width:96px">Send</button>
            <button id="chatClear" style="background:#1f2937;border:1px solid #243244;color:#e5e7eb;border-radius:6px;padding:6px 10px;font-size:12px;cursor:pointer;">Clear</button>
            <div id="chatLoading" style="display:none; font-size:11px; color:#93c5fd; align-items:center; gap:6px; padding:2px 4px;">
              <span class="spinner" style="width:14px; height:14px; border:2px solid #3b82f6; border-right-color:transparent; border-radius:50%; display:inline-block; animation:spin .7s linear infinite;"></span>
              <span>Running…</span>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="card" style="flex:1; min-width:320px; min-height:240px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; gap:10px;">
            <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
              <div style="font-weight:600; display:flex; align-items:center; gap:8px;">Answer <span id="llmBadge" class="pill" style="display:none; background:#a78bfa; color:#0b0f14; font-weight:700;">LLM</span></div>
              <span style="display:inline-flex; background:#111b27; border:1px solid #243244; border-radius:6px; overflow:hidden;">
                <button type="button" id="tabSummary" style="background:#1e293b; color:#e5e7eb; border:none; padding:4px 10px; font-size:12px; cursor:pointer;">DB</button>
                <button type="button" id="tabNarrative" style="background:transparent; color:#9ca3af; border:none; padding:4px 10px; font-size:12px; cursor:pointer;">LLM</button>
              </span>
            </div>
            <div style="display:flex; gap:6px; align-items:center;">
              <button id="forceLlmBtn" class="btn" type="button" style="display:none; font-size:11px; padding:4px 8px;" title="Ask LLM for deeper narrative">Ask LLM</button>
              <button id="copySummaryBtn" class="btn" type="button" disabled title="Copy summary to clipboard">Copy summary</button>
            </div>
          </div>
          <!-- Removed fixed min-height to eliminate large blank gap when no callout is shown -->
          <div id="answerCalloutContainer" style="position:relative;">
            <div id="chatCallout" style="display:none; margin-bottom:8px; padding:6px 8px; border-radius:6px; border:1px solid #243244; background:#0f172a; font-size:12px; font-weight:600;">
              <span id="chatCalloutText"></span>
              <button id="calloutInfoBtn" title="Show reliability threshold legend" style="float:right; background:transparent; border:none; color:#93c5fd; cursor:pointer; font-size:12px; padding:0; margin-left:8px;">ℹ️</button>
            </div>
            <div id="calloutLegend" style="display:none; position:absolute; top:100%; right:0; z-index:20; background:#0b1220; border:1px solid #243244; border-radius:8px; padding:8px; width:260px; font-size:11px; line-height:1.3; box-shadow:0 4px 16px rgba(0,0,0,0.4);">
              <div style="font-weight:600; margin-bottom:4px;">Reliability Legend</div>
              <div id="calloutLegendBody" style="display:flex; flex-direction:column; gap:4px;"></div>
              <div class="muted" style="margin-top:6px;">Evaluated each refresh; improvements are debounced briefly to reduce flicker.</div>
            </div>
          </div>
          <div id="chatAnswer" style="font-size:13px; line-height:1.35; white-space:normal;">—</div>
          <div id="chatNarrative" style="display:none; margin-top:8px; font-size:13px; line-height:1.35; white-space:normal;"></div>
          <div id="noLlmNote" class="muted" style="display:none; margin-top:6px; font-size:11px; border:1px dashed #334155; padding:6px 8px; border-radius:6px; background:#0f172a;">Deterministic DB summary shown. Click <strong>Ask LLM</strong> for a deeper narrative.</div>
          <div id="chatEvidence" style="display:none; margin-top:10px; font-size:11px;"></div>
          <div id="chatAnswerMeta" class="muted" style="font-size:11px; margin-top:6px;"></div>
        </div>
        <div class="card" style="flex:1; min-width:320px; min-height:220px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
            <div style="font-weight:600;">Diagram</div>
            <label class="muted" style="font-size:12px; display:flex; gap:6px; align-items:center;">
              View:
              <select id="chatDiagramMode" style="background:#111827;color:#e5e7eb;border:1px solid #243244;border-radius:6px;padding:2px 6px;">
                <option value="auto" selected>Auto</option>
                <option value="errors">Errors</option>
                <option value="latency">Latency</option>
                <option value="tokens">Tokens</option>
              </select>
            </label>
          </div>
          <canvas id="chatDiagramCanvas" height="200" style="width:100%; background:#0f172a; border:1px solid #243244; border-radius:6px;"></canvas>
          <div id="chatDiagramEmpty" class="muted" style="font-size:12px; display:none;">No data to visualize.</div>
        </div>
      </div>
      <!-- Conversation history panel -->
      <div class="card" style="margin-top:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div style="font-weight:600;">Conversation</div>
          <button id="chatHistoryClear" class="btn" type="button" style="font-size:11px; padding:4px 8px;">Clear</button>
        </div>
        <div id="chatHistoryList" style="margin-top:6px; max-height:160px; overflow:auto; font-size:12px; border:1px solid #243244; border-radius:6px; background:#0f172a;"></div>
      </div>
      <div class="card" style="margin-top:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div style="font-weight:600;">Logs in selected range</div>
          <div id="chatLogsMeta" class="muted" style="font-size:12px"></div>
        </div>
        <div style="overflow:auto; max-height:240px; margin-top:8px;">
          <table id="chatLogsTable" style="width:100%; border-collapse:collapse; font-size:12px;">
            <thead>
              <tr>
                <th style="text-align:left; border-bottom:1px solid #243244; padding:6px;">Time</th>
                <th style="text-align:left; border-bottom:1px solid #243244; padding:6px;">Status</th>
                <th style="text-align:left; border-bottom:1px solid #243244; padding:6px;">Endpoint</th>
                <th style="text-align:left; border-bottom:1px solid #243244; padding:6px;">Model</th>
                <th style="text-align:left; border-bottom:1px solid #243244; padding:6px;">Region</th>
                <th style="text-align:left; border-bottom:1px solid #243244; padding:6px;">Text</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
    <footer>Auto-refresh every 15s. Probes: multiple endpoints (round-robin by default).</footer>
    <script>
      // Synthetic Monitor Modal
      const synthModal = document.createElement('div');
      synthModal.id = 'synthModal';
      synthModal.style.cssText = 'display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:9999;';
      synthModal.innerHTML = `
        <div style="background:#0b0f14; border:1px solid #243244; border-radius:10px; padding:14px; width:min(720px,92vw); color:#e5e7eb;">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px;">
            <div style="font-weight:700;">Create Synthetic Monitor</div>
            <button id="synthClose" class="btn" type="button">Close</button>
          </div>
          <div class="muted" style="font-size:12px; margin-bottom:8px;">Describe the synthetic test in natural language. We'll draft a test spec, you can edit, then create and run it. If a site needs login, you can include cookies under <code>auth.cookies</code> or headers under <code>auth.headers</code> in the spec.</div>
          <textarea id="synthPrompt" rows="3" placeholder="e.g., Create a synthetic test to https://chatgpt.com. In the input box, type 'tell me a joke' and hit Enter. Pass if a response is shown." style="width:100%; background:#111827; color:#e5e7eb; border:1px solid #243244; border-radius:6px; padding:8px;"></textarea>
          <div style="display:flex; gap:8px; margin-top:8px;">
            <button id="synthDraft" class="btn btn-primary" type="button">Draft with AI</button>
            <span id="synthMsg" class="muted"></span>
          </div>
          <div style="margin-top:8px;">
            <label class="muted" style="font-size:12px;">Spec</label>
            <textarea id="synthSpec" rows="10" style="width:100%; background:#111827; color:#e5e7eb; border:1px solid #243244; border-radius:6px; padding:8px; font-family:ui-monospace, monospace;"></textarea>
          </div>
          <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
            <button id="synthCreate" class="btn btn-accent" type="button">Create Monitor</button>
            <button id="synthRun" class="btn" type="button" disabled>Run Now</button>
            <span id="synthRunMsg" class="muted"></span>
          </div>
          <div id="synthRunOutput" class="muted" style="font-size:12px; margin-top:8px;"></div>
        </div>`;
      document.body.appendChild(synthModal);
      function openSynth(){ synthModal.style.display='flex'; }
      function closeSynth(){ synthModal.style.display='none'; }
      document.getElementById('createSyntheticBtn').addEventListener('click', openSynth);
      synthModal.querySelector('#synthClose').addEventListener('click', closeSynth);
      synthModal.addEventListener('click', (e)=>{ if(e.target===synthModal) closeSynth(); });

      async function draftSynth(){
        const msg = document.getElementById('synthMsg'); msg.textContent='Drafting…';
        try{
          const prompt = document.getElementById('synthPrompt').value.trim();
          const r = await fetch('/synthetics/draft',{ method:'POST', headers:{ 'content-type':'application/json' }, body: JSON.stringify({ prompt }) });
          const j = await r.json();
          if(!r.ok){ msg.textContent = 'Draft failed: '+(j.error||r.status); return; }
          document.getElementById('synthSpec').value = JSON.stringify(j.spec, null, 2);
          msg.textContent = 'Draft ready — review/edit the spec below.';
        }catch(e){ msg.textContent='Draft error'; }
      }
      async function createSynth(){
        const msg = document.getElementById('synthMsg');
        msg.textContent='Creating…';
        try{
          let spec; try{ spec = JSON.parse(document.getElementById('synthSpec').value); }catch(_){ msg.textContent='Invalid JSON spec'; return; }
          const r = await fetch('/synthetics',{ method:'POST', headers:{ 'content-type':'application/json' }, body: JSON.stringify({ spec }) });
          const j = await r.json();
          if(!r.ok){ msg.textContent='Create failed: '+(j.error||r.status); return; }
          msg.textContent='Created monitor #'+j.id;
          const runBtn = document.getElementById('synthRun'); runBtn.disabled=false; runBtn.dataset.id=String(j.id);
          try{ loadSynthMonitors(); }catch(_){ }
        }catch(e){ msg.textContent='Create error'; }
      }
      async function runSynth(){
        const runBtn = document.getElementById('synthRun'); const id = runBtn.dataset.id; if(!id) return;
        const msg = document.getElementById('synthRunMsg'); const out = document.getElementById('synthRunOutput');
        msg.textContent='Running…'; out.innerHTML='';
        try{
          const r = await fetch(`/synthetics/${id}/run`,{ method:'POST' });
          const j = await r.json();
          if(!r.ok){ msg.textContent='Run failed: '+(j.error||r.status); return; }
          msg.textContent = j.ok ? 'Run OK' : ('Run failed: '+(j.statusText||''));
          const logs = (j.logs||[]).map(l=> new Date(l.ts).toISOString()+': '+l.msg).join('\n');
          out.textContent = logs || '(no logs)';
          if (j.screenshot){ const img = document.createElement('img'); img.src = j.screenshot; img.alt = 'screenshot'; img.style.maxWidth='100%'; img.style.marginTop='8px'; out.appendChild(document.createElement('br')); out.appendChild(img); }
          try{ loadSynthRuns(); }catch(_){ }
        }catch(e){ msg.textContent='Run error'; }
      }
      document.getElementById('synthDraft').addEventListener('click', draftSynth);
      document.getElementById('synthCreate').addEventListener('click', createSynth);
      document.getElementById('synthRun').addEventListener('click', runSynth);
      // Lightweight Markdown renderer with sanitization (basic headings, emphasis, code, links, lists, blockquotes)
      function mdEscapeHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
      function mdAttrEscape(s){return String(s||'').replace(/"/g,'&quot;').replace(/</g,'').replace(/>/g,'');}
      function mdToHtml(input){
        try{
          if(!input) return '';
          let src = String(input);
          // Extract fenced code blocks first
          const blocks=[];
          src = src.replace(/```([a-zA-Z0-9_+-]+)?\n([\s\S]*?)```/g,(m,lang,code)=>{const idx=blocks.push({lang:lang||'', code:code})-1;return `\u0000CODEBLOCK${idx}\u0000`;});
          // Escape remaining HTML
          src = mdEscapeHtml(src);
          // Headings
          src = src.replace(/^######\s+(.*)$/gm,'<h6>$1</h6>')
                   .replace(/^#####\s+(.*)$/gm,'<h5>$1</h5>')
                   .replace(/^####\s+(.*)$/gm,'<h4>$1</h4>')
                   .replace(/^###\s+(.*)$/gm,'<h3>$1</h3>')
                   .replace(/^##\s+(.*)$/gm,'<h2>$1</h2>')
                   .replace(/^#\s+(.*)$/gm,'<h1>$1</h1>');
          // Blockquotes
          src = src.replace(/^>\s?(.*)$/gm,'<blockquote>$1</blockquote>');
          // Lists (unordered)
          src = src.replace(/^(?:\s*[-*]\s+.*(?:\n|$))+?/gm, (m)=>{
            const items = m.trim().split(/\n/).map(l=>l.replace(/^\s*[-*]\s+/,'').trim()).filter(Boolean);
            return '<ul>'+items.map(t=>'<li>'+t+'</li>').join('')+'</ul>';
          });
          // Lists (ordered)
          src = src.replace(/^(?:\s*\d+\.\s+.*(?:\n|$))+?/gm, (m)=>{
            const items = m.trim().split(/\n/).map(l=>l.replace(/^\s*\d+\.\s+/,'').trim()).filter(Boolean);
            return '<ol>'+items.map(t=>'<li>'+t+'</li>').join('')+'</ol>';
          });
          // Inline code
          src = src.replace(/`([^`]+?)`/g,'<code>$1</code>');
          // Bold and italic (order matters)
          src = src.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>');
          src = src.replace(/\*([^*]+)\*/g,'<em>$1</em>');
          // Links [text](url)
          src = src.replace(/\[([^\]]+)]\(([^)\s]+)\)/g,(m,txt,url)=>{
            try{ const safeUrl = mdAttrEscape(url); return `<a href="${safeUrl}" target="_blank" rel="noopener noreferrer">${txt}</a>`; }catch{ return txt; }
          });
          // Paragraphs: split by double newlines not already converted
          src = src.replace(/(?:^|\n)([^<\n][^\n]*)(?=\n|$)/g, (m, line)=>{
            if(/^(<h\d|<ul>|<ol>|<blockquote>|<pre>|<p>|<hr|<div)/.test(line.trim())) return '\n'+line; // already wrapped
            const t=line.trim(); if(!t) return '';
            return '\n<p>'+t+'</p>';
          });
          // Restore code blocks (escape inside now)
          src = src.replace(/\u0000CODEBLOCK(\d+)\u0000/g,(m,idx)=>{
            const b = blocks[Number(idx)]; if(!b) return '';
            const codeHtml = mdEscapeHtml(b.code.replace(/^\n+|\n+$/g,''));
            const lang = mdAttrEscape(b.lang);
            const cls = lang? ` class="lang-${lang}"` : '';
            return `<pre><code${cls}>${codeHtml}</code></pre>`;
          });
          return src;
        }catch(_){ return mdEscapeHtml(String(input)); }
      }
      const traceState={cursor:null,direction:'prev',serverCursors:null,currentPage:[],sort:{key:'ts',dir:'desc'}};
      function selectedEndpoints(){const v=document.getElementById('endpointFilter').value;return (!v||v==='__all__')?[]:[v];}
  function getWindow(){return Number(document.getElementById('windowSelect').value);} function toEpoch(dt){return dt?new Date(dt).getTime():null;} function absoluteRange(){const use=document.getElementById('useCustomRange');if(!use||!use.checked) return null;const f=toEpoch(document.getElementById('fromTs').value);const t=toEpoch(document.getElementById('toTs').value);return (f&&t&&t>f)?{from:f,to:t}:null;}
  function updateRangeInputsEnabled(){const use=document.getElementById('useCustomRange');const on=!!(use&&use.checked);['fromTs','toTs','applyRange'].forEach(id=>{const el=document.getElementById(id);if(el){el.disabled=!on;el.style.opacity=on?"1":"0.6";el.style.pointerEvents=on?"auto":"none";}});}
      async function load(resetCursor=true){
        try {
          const win=getWindow();
          const eps=selectedEndpoints();
          const abs=absoluteRange();
            const query=abs?new URLSearchParams({from:String(abs.from),to:String(abs.to)}):new URLSearchParams({window:String(win)});
          if(eps.length) query.set('endpoint',eps.join(','));
          const traceParams=new URLSearchParams(query.toString());
          traceParams.set('limit','200');
          if(traceState.cursor&&!resetCursor){traceParams.set('cursor',String(traceState.cursor));traceParams.set('direction',traceState.direction);} 
          if(document.getElementById('errorsOnly').checked) traceParams.set('errorsOnly','1');
          const slowVal=document.getElementById('slowMs').value; if(slowVal) traceParams.set('slowMs',slowVal);
          const [statusRes,tracesRes]=await Promise.all([
            fetch('/status?'+query.toString(),{cache:'no-store'}),
            fetch('/traces?'+traceParams.toString(),{cache:'no-store'})
          ]);
          const statusJson=await statusRes.json();
          const tracesJson=await tracesRes.json();
          if(resetCursor){traceState.cursor=null;traceState.direction='prev';}
          traceState.serverCursors=tracesJson.cursor;
          document.getElementById('since').textContent=`(since ${new Date(statusJson.since).toLocaleString()})`;
          const cards=document.getElementById('cards');
          cards.innerHTML='';
          const endpointKeys=Object.keys(statusJson.endpoints);
          if(!endpointKeys.length){cards.innerHTML='<div class="muted">No data yet. Waiting for first probe…</div>';populateEndpointFilter([]);return;}
          populateEndpointFilter(endpointKeys);
          endpointKeys.forEach(ep=>{
            const s=statusJson.endpoints[ep];
            const okRate=s.successRate==null?'–':(s.successRate*100).toFixed(2)+'%';
            const lat=s.latencyMs||{};
            const errList=Object.entries(s.errors).map(([k,v])=>`<span class="pill">${k}: ${v}</span>`).join(' ');
            const tsId='ts_'+ep.replace(/[^a-z0-9]/gi,'_');
            const errLabel=abs?'(custom)':`(${win}m)`;
            const cardHtml=`<div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div><span class="k">Endpoint</span> <span class="v">${ep}</span></div><div class="${s.successRate>=0.995?'ok':'bad'}">${okRate}</div></div><table><tr><th>Total</th><th>OK</th><th>p50</th><th>p95</th><th>p99</th></tr><tr><td>${s.total}</td><td>${s.ok}</td><td>${lat.p50 ?? '–'} ms</td><td>${lat.p95 ?? '–'} ms</td><td>${lat.p99 ?? '–'} ms</td></tr></table><div style="margin-top:8px"><div class="muted" style="margin-bottom:6px">Errors ${errLabel}</div><div>${errList||'<span class=\"muted\">none</span>'}</div></div><div style=\"margin-top:8px\"><div class=\"muted\" style=\"margin-bottom:4px\">Latency p95 over time</div><canvas id=\"${tsId}\" height=\"40\" style=\"width:100%;background:#0f172a;border:1px solid #243244;border-radius:4px\"></canvas><div id=\"${tsId}_hover\" class=\"muted\" style=\"margin-top:4px;font-size:11px;min-height:14px\"></div></div></div>`;
            const wrapper=document.createElement('div');
            wrapper.innerHTML=cardHtml;
            cards.appendChild(wrapper.firstElementChild);
            fetchEndpointTimeseries(ep,tsId,abs,win);
          });
          const tbody=document.querySelector('#tracesTable tbody');
          tbody.innerHTML='';
          let points=tracesJson.points.slice();
          points.sort((a,b)=>{const k=traceState.sort.key;let av=a[k],bv=b[k];if(k==='iso'||k==='ts'){av=a.ts;bv=b.ts;}if(typeof av==='string'){av=av.toLowerCase();bv=String(bv).toLowerCase();}if(av<bv) return traceState.sort.dir==='asc'?-1:1;if(av>bv) return traceState.sort.dir==='asc'?1:-1;return 0;});
          traceState.currentPage=points;
          points.forEach(p=>{const tr=document.createElement('tr');const slowThreshold=document.getElementById('slowMs').value?Number(document.getElementById('slowMs').value):null;const highlight=!p.ok?'#fb7185':(slowThreshold&&p.latencyMs>=slowThreshold?'#f59e0b':'');tr.innerHTML=`<td>${p.iso}</td><td>${p.status ?? ''}</td><td>${p.ok?'✔':'✖'}</td><td>${p.latencyMs}</td><td>${p.endpoint}</td><td>${p.model||''}</td><td>${p.region||''}</td><td>${p.errType||''}</td><td>${p.tokensTotal ?? ''}</td><td>${p.respBytes ?? ''}</td>`;if(highlight) tr.style.color=highlight;if(!p.ok) tr.style.color='#fb7185';tbody.appendChild(tr);});
          document.getElementById('traceMeta').textContent=`Returned ${tracesJson.returned}/${tracesJson.total} points (limit=${tracesJson.limit}) cursor(prev=${tracesJson.cursor.prev},next=${tracesJson.cursor.next})`;
          document.getElementById('prevPage').disabled=!tracesJson.cursor||!tracesJson.cursor.prev;
          document.getElementById('nextPage').disabled=!tracesJson.cursor||!tracesJson.cursor.next;
          document.getElementById('lastRefresh').textContent='Last refresh: '+new Date().toLocaleTimeString();
        } catch(e){
          console.error(e);
          document.getElementById('lastRefresh').textContent='Last refresh error';
        }
      }
      function pad(n){return String(n).padStart(2,'0');}
      function toLocalInput(ts){const d=new Date(ts);return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;}
      function syncPresetToRange(){const mins=getWindow();const now=Date.now();const from=now-mins*60000;document.getElementById('fromTs').value=toLocalInput(from);document.getElementById('toTs').value=toLocalInput(now);} 
      function populateEndpointFilter(eps){
        const sel=document.getElementById('endpointFilter');
        const current=sel.value||'__all__';
        sel.innerHTML='';
        const all=document.createElement('option');all.value='__all__';all.textContent='All endpoints';sel.appendChild(all);
        eps.forEach(ep=>{const o=document.createElement('option');o.value=ep;o.textContent=ep;sel.appendChild(o);});
        // restore selection if still present; otherwise default to All
        const hasCurrent=[...sel.options].some(o=>o.value===current);
        sel.value=hasCurrent?current:'__all__';
      }
      function buildCurrentSummary(){return [...document.querySelectorAll('.card')].map(c=>{const ep=c.querySelector('.v').textContent.trim();const nums=[...c.querySelectorAll('table tr:nth-child(2) td')].map(td=>td.textContent.replace(' ms',''));return {endpoint:ep,total:Number(nums[0]),ok:Number(nums[1]),p50:nums[2],p95:nums[3],p99:nums[4]};});}
      function exportCsv(){const data=buildCurrentSummary();if(!data.length)return;const header=['endpoint','total','ok','p50','p95','p99'];const lines=[header.join(','),...data.map(r=>header.map(h=>r[h]).join(','))];download('status.csv',lines.join('\n'));}function exportJson(){const data=buildCurrentSummary();download('status.json',JSON.stringify(data,null,2));}
      function exportTrace(fmt){if(!traceState.currentPage.length)return;if(fmt==='json')return download('traces_page.json',JSON.stringify(traceState.currentPage,null,2));const header=['iso','status','ok','latencyMs','endpoint','model','region','errType','tokensTotal','tokensPrompt','tokensCompletion','respBytes'];const lines=[header.join(','),...traceState.currentPage.map(r=>header.map(h=>r[h]??'').join(','))];download('traces_page.csv',lines.join('\n'));}
      async function exportAllTraces(fmt){try{const win=getWindow();const eps=selectedEndpoints();const abs=absoluteRange();const base=abs?new URLSearchParams({from:String(abs.from),to:String(abs.to)}):new URLSearchParams({window:String(win)});if(eps.length) base.set('endpoint',eps.join(','));if(document.getElementById('errorsOnly').checked) base.set('errorsOnly','1');const slowVal=document.getElementById('slowMs').value;if(slowVal) base.set('slowMs',slowVal);let all=[];let cursor=null;let direction='prev';const limit=500;let safety=0;while(safety<50){const qp=new URLSearchParams(base.toString());qp.set('limit',String(limit));if(cursor){qp.set('cursor',String(cursor));qp.set('direction',direction);}const r=await fetch('/traces?'+qp.toString());const j=await r.json();all=all.concat(j.points);if(!j.cursor||!j.cursor.next||j.points.length<limit) break;cursor=j.cursor.next;direction='prev';safety++;}if(fmt==='json')return download('traces_all.json',JSON.stringify(all,null,2));const header=['iso','status','ok','latencyMs','endpoint','model','region','errType','tokensTotal','tokensPrompt','tokensCompletion','respBytes'];const lines=[header.join(','),...all.map(r=>header.map(h=>r[h]??'').join(','))];download('traces_all.csv',lines.join('\n'));}catch(e){console.error('export all traces failed',e);}}
  async function fetchEndpointTimeseries(ep,id,abs,win){try{const params=abs?new URLSearchParams({from:String(abs.from),to:String(abs.to),endpoint:ep}):new URLSearchParams({window:String(win),endpoint:ep});params.set('stepSec','60');const r=await fetch('/timeseries?'+params.toString(),{cache:'no-store'});if(!r.ok) return;const j=await r.json();const canvas=document.getElementById(id);if(!canvas)return;const ctx=canvas.getContext('2d');const hoverEl=document.getElementById(id+'_hover');const buckets=j.buckets||[];const vals=buckets.map(b=>b.p95).filter(v=>v!=null);ctx.clearRect(0,0,canvas.width,canvas.height);if(!vals.length){ctx.fillStyle='#64748b';ctx.font='10px system-ui';ctx.fillText('no data',4,18);return;}const w=canvas.clientWidth||canvas.width;const h=canvas.height;canvas.width=w;const tMin=buckets[0].t,tMax=buckets[buckets.length-1].t;const maxV=Math.max(...vals,1);ctx.strokeStyle='#2563eb';ctx.beginPath();buckets.forEach((b,i)=>{const v=b.p95||0;const x=(b.t-tMin)/(tMax-tMin||1)*(w-1);const y=h- (v/maxV)*(h-4)-2;if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);});ctx.stroke(); // hover interaction
    canvas.onmousemove=(e)=>{const rect=canvas.getBoundingClientRect();const x=e.clientX-rect.left;const rel=x/(w-1);const t=tMin+rel*(tMax-tMin);let nearest=null;for(const b of buckets){if(!nearest||Math.abs(b.t-t)<Math.abs(nearest.t-t)) nearest=b;}if(nearest){const v=nearest.p95!=null?nearest.p95.toFixed(0)+'ms':'—';if(hoverEl) hoverEl.textContent=new Date(nearest.t).toLocaleTimeString()+': p95 '+v;}};canvas.onmouseleave=()=>{if(hoverEl) hoverEl.textContent='';};}catch(e){/* ignore */}}
  // Probe interval dropdown logic
  async function initProbeInterval(){try{const r=await fetch('/config',{cache:'no-store'});if(!r.ok)return;const j=await r.json();const sel=document.getElementById('probeIntervalSelect');if(!sel)return;const cur=j && j.probe ? j.probe.intervalSec : 60; // set existing
          // Evidence (grounding log snippets) for streaming final payload
          try {
            const evBox=document.getElementById('chatEvidence');
            if(evBox){
              const ev=Array.isArray(obj.evidence)?obj.evidence:[];
              if(ev.length){
                evBox.style.display='block';
                evBox.innerHTML='<div style="font-weight:600;font-size:12px;margin-bottom:4px;">Evidence (logs)</div>'+ev.map(e=>{
                  const dt=new Date(e.ts||Date.now()).toISOString();
                  const meta=[dt,e.status||'',e.endpoint||'',e.model||'',e.region||''].filter(Boolean).join(' • ');
                  const safe=(e.text||'').replace(/[<>]/g,'');
                  return `<div class="ev-item" style="border:1px solid #243244;border-radius:6px;padding:6px;margin-bottom:6px;font-size:11px;">
                    <div style="color:#9ca3af;margin-bottom:4px;">${meta} <button data-text="${safe.replace(/"/g,'&quot;')}" class="btn ev-copy" style="float:right;font-size:10px;padding:2px 6px;">Copy</button></div>
                    <div style="white-space:pre-wrap;font-family:ui-monospace,monospace;">${safe}</div>
                  </div>`;
                }).join('');
                evBox.querySelectorAll('.ev-copy').forEach(btn=>{btn.addEventListener('click',()=>{try{navigator.clipboard.writeText(btn.getAttribute('data-text')||'');btn.textContent='Copied';setTimeout(()=>{btn.textContent='Copy';},1100);}catch(_){}});});
              } else { evBox.innerHTML=''; evBox.style.display='none'; }
            }
          }catch(_){ }
    if([...sel.options].some(o=>o.value==String(cur))) sel.value=String(cur);sel.addEventListener('change',async()=>{const nv=Number(sel.value);try{const resp=await fetch('/probe/interval',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({intervalSec:nv})});if(!resp.ok){sel.classList.add('bad');setTimeout(()=>sel.classList.remove('bad'),1200);} }catch(_){}});}catch(_){}}
  initProbeInterval();
  function download(filename,text){const blob=new Blob([text],{type:'text/plain'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=filename;a.click();setTimeout(()=>URL.revokeObjectURL(a.href),4000);}function setActiveTab(id){['viewSummary','viewTraces','viewChat','viewSynthetics'].forEach(x=>{const el=document.getElementById(x);if(el){if(x===id)el.classList.add('active');else el.classList.remove('active');}})}
  document.getElementById('windowSelect').addEventListener('change',()=>{syncPresetToRange();load(true);updateEnhancements();refreshChatLogs();});
  document.getElementById('useCustomRange').addEventListener('change',()=>{updateRangeInputsEnabled();load(true);updateEnhancements();refreshChatLogs();});
  document.getElementById('applyRange').addEventListener('click',()=>{load(true);updateEnhancements();refreshChatLogs();});
  document.getElementById('endpointFilter').addEventListener('change',()=>{load(true);updateEnhancements();refreshChatLogs();});
  document.getElementById('exportCsv').addEventListener('click',exportCsv);
  document.getElementById('exportJson').addEventListener('click',exportJson);
  document.getElementById('viewSummary').addEventListener('click',()=>{
    document.getElementById('tracesContainer').style.display='none';
    document.getElementById('chatContainer').style.display='none';
    const sc=document.getElementById('syntheticsContainer'); if(sc) sc.style.display='none';
    document.getElementById('cards').style.display='flex';
    document.getElementById('enhancements').style.display='block';
    setActiveTab('viewSummary');
    stopChatLogsTimer();
    stopSynthTimer();
  });
  document.getElementById('viewTraces').addEventListener('click',()=>{
    document.getElementById('cards').style.display='none';
    document.getElementById('enhancements').style.display='none';
    document.getElementById('chatContainer').style.display='none';
    const sc=document.getElementById('syntheticsContainer'); if(sc) sc.style.display='none';
    document.getElementById('tracesContainer').style.display='block';
    setActiveTab('viewTraces');
  stopChatLogsTimer();
  stopSynthTimer(); stopCountdowns();
  });
  document.getElementById('viewChat').addEventListener('click',()=>{
    document.getElementById('cards').style.display='none';
    document.getElementById('enhancements').style.display='none';
    document.getElementById('tracesContainer').style.display='none';
    const sc=document.getElementById('syntheticsContainer'); if(sc) sc.style.display='none';
    document.getElementById('chatContainer').style.display='block';
    setActiveTab('viewChat');
    refreshChatLogs();
    startChatLogsTimer();
  stopSynthTimer(); stopCountdowns();
  });
  // Synthetics tab navigation + listing
  document.getElementById('viewSynthetics').addEventListener('click',()=>{
    document.getElementById('cards').style.display='none';
    document.getElementById('enhancements').style.display='none';
    document.getElementById('tracesContainer').style.display='none';
    document.getElementById('chatContainer').style.display='none';
    const sc=document.getElementById('syntheticsContainer'); if(sc) sc.style.display='block';
    setActiveTab('viewSynthetics');
  stopChatLogsTimer(); updateCountdowns();
    loadSynthMonitors();
    loadSynthRuns();
    startSynthTimer();
  });
  async function loadSynthMonitors(){
    try{
      const showDeleted=document.getElementById('showDeletedSynth')?.checked;
      const r=await fetch('/synthetics'+(showDeleted?'?deleted=1':''),{cache:'no-store'}); if(!r.ok) return;
      const j=await r.json();
      const tbody=document.querySelector('#synthMonitorsTable tbody'); if(!tbody) return;
      tbody.innerHTML='';
      (j.items||[]).forEach(m=>{
        const tr=document.createElement('tr');
        const created=m.createdAt? new Date(m.createdAt).toLocaleString(): '';
        const sched = m.schedule || 'manual';
        const lastRun = m.lastRun ? `${new Date(m.lastRun.startedAt).toLocaleString()} • ${m.lastRun.ok? 'OK' : (m.lastRun.statusText||'fail')}` : '';
        const nextRun = m.nextDueAt ? new Date(m.nextDueAt).toLocaleString() : '';
        const schedSel = `<select data-sched-id="${m.id}" style="background:#111827;color:#e5e7eb;border:1px solid #243244;border-radius:4px;padding:2px 4px;">
          <option value="manual" ${sched==='manual'?'selected':''}>manual</option>
          <option value="every_1m" ${sched==='every_1m'?'selected':''}>every 1m</option>
          <option value="every_5m" ${sched==='every_5m'?'selected':''}>every 5m</option>
          <option value="every_10m" ${sched==='every_10m'?'selected':''}>every 10m</option>
          <option value="every_15m" ${sched==='every_15m'?'selected':''}>every 15m</option>
          <option value="every_30m" ${sched==='every_30m'?'selected':''}>every 30m</option>
          <option value="hourly" ${sched==='hourly'?'selected':''}>hourly</option>
        </select>`;
        const deletedBadge = m.deleted? '<span class="pill" style="background:#475569;color:#e2e8f0;">deleted</span>' : '';
        const isDefault = /ChatGPT Synthetic Test/i.test(m.name||'') || m.id===1;
        const nameCell = `${m.name||m.spec?.name||''}${isDefault? '<span class="badge-default" title="Seeded default monitor">default</span>':''}`;
        tr.innerHTML=`<td style="padding:6px;border-bottom:1px solid #243244;">${m.id}</td>
          <td style="padding:6px;border-bottom:1px solid #243244;">${nameCell}</td>
          <td style="padding:6px;border-bottom:1px solid #243244;">${schedSel}</td>
          <td style="padding:6px;border-bottom:1px solid #243244;">${lastRun}</td>
          <td style="padding:6px;border-bottom:1px solid #243244;" data-next-ts="${m.nextDueAt||''}">${nextRun}</td>
          <td style="padding:6px;border-bottom:1px solid #243244;" data-countdown="${m.nextDueAt||''}">${m.nextDueAt? '—' : ''}</td>
          <td style="padding:6px;border-bottom:1px solid #243244;">${created} ${deletedBadge}</td>
          <td style="padding:6px;border-bottom:1px solid #243244;">${ m.deleted 
            ? `<button class='btn' data-restore-id='${m.id}'>Restore</button>` 
            : `<button class=\"btn\" data-run-id=\"${m.id}\">Run</button> <button class=\"btn\" data-edit-id=\"${m.id}\">Edit</button> <button class=\"btn btn-danger\" title=\"Delete monitor\" data-del-id=\"${m.id}\" style=\"padding:4px 6px;\">🗑️</button>`}
          </td>`;
        tbody.appendChild(tr);
      });
      updateCountdowns?.();
      tbody.querySelectorAll('button[data-run-id]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id=btn.getAttribute('data-run-id'); btn.disabled=true; const old=btn.textContent; btn.textContent='Running…';
          try{
            const r2=await fetch(`/synthetics/${id}/run`,{method:'POST'});
            const jr=await r2.json().catch(()=>({}));
            // Poll runs until we see the runId or timeout (15s)
            if (r2.ok && jr && jr.runId){
              const targetRunId = jr.runId; const started=Date.now();
              const poll = async ()=>{
                try{
                  const rr=await fetch('/synthetics/runs?cache='+Date.now(),{cache:'no-store'}); if(rr.ok){ const jj=await rr.json(); if(Array.isArray(jj.items) && jj.items.some(r=>r.id===targetRunId)){ loadSynthRuns(); return true; } }
                }catch(_){ }
                return false;
              };
              let found=false; while(Date.now()-started<15000 && !found){ found=await poll(); if(!found) await new Promise(r=>setTimeout(r,1000)); }
            }
          }catch(_){ }
          btn.disabled=false; btn.textContent=old||'Run';
          loadSynthRuns();
        });
      });
      tbody.querySelectorAll('button[data-restore-id]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id=btn.getAttribute('data-restore-id');
          try{ await fetch(`/synthetics/${id}/restore`,{method:'POST'}); }catch(_){ }
          loadSynthMonitors();
        });
      });
      tbody.querySelectorAll('button[data-edit-id]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id=btn.getAttribute('data-edit-id');
          openEditMonitor(id);
        });
      });
      // Delete buttons
      tbody.querySelectorAll('button[data-del-id]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id=btn.getAttribute('data-del-id');
          if(!id) return; if(!confirm('Delete synthetic monitor #'+id+'?')) return;
          try { const r=await fetch(`/synthetics/${id}`,{ method:'DELETE' }); if(!r.ok){ alert('Delete failed '+r.status); } else { loadSynthMonitors(); loadSynthRuns(); } } catch(_){ alert('Delete error'); }
        });
      });
      // Handle schedule changes
      tbody.querySelectorAll('select[data-sched-id]').forEach(sel=>{
        sel.addEventListener('change', async ()=>{
          const id = sel.getAttribute('data-sched-id');
          const schedule = sel.value;
          try{
            await fetch(`/synthetics/${id}/schedule`,{ method:'PATCH', headers:{ 'content-type':'application/json' }, body: JSON.stringify({ schedule }) });
          }catch(_){ }
        });
      });
    }catch(_){ /* ignore */ }
  }
  async function loadSynthRuns(){
    try{
      const r=await fetch('/synthetics/runs',{cache:'no-store'}); if(!r.ok) return;
      const j=await r.json();
      const tbody=document.querySelector('#synthRunsTable tbody'); if(!tbody) return;
      tbody.innerHTML='';
      (j.items||[]).forEach(run=>{
        const started=run.startedAt? new Date(run.startedAt).toLocaleString(): '';
        const ok=!!run.ok; const status= ok? '<span class="pill" style="background:#34d399; color:#0b0f14; font-weight:600;">OK</span>' : `<span class="pill" style="background:#fb7185; color:#0b0f14; font-weight:600;">${(run.statusText||'fail')}</span>`;
        const shot= run.screenshot ? `<a href="${run.screenshot}" target="_blank" rel="noopener">view</a>` : '';
        const tr=document.createElement('tr');
        tr.innerHTML=`<td style="padding:6px;border-bottom:1px solid #243244;"><button class="btn" data-run-detail="${run.id}">#${run.id}</button></td>
          <td style="padding:6px;border-bottom:1px solid #243244;">#${run.monitorId}</td>
          <td style="padding:6px;border-bottom:1px solid #243244;">${started}</td>
          <td style="padding:6px;border-bottom:1px solid #243244;">${status}</td>
          <td style="padding:6px;border-bottom:1px solid #243244;">${shot}</td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('button[data-run-detail]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const rid=btn.getAttribute('data-run-detail');
          try{ const r=await fetch(`/synthetics/runs/${rid}`,{cache:'no-store'}); if(!r.ok) return; const j=await r.json(); openRunDetail(j); }catch(_){ }
        });
      });
    }catch(_){ /* ignore */ }
  }
  let synthTimer=null; function startSynthTimer(){ if(synthTimer) return; synthTimer=setInterval(()=>{ const vis=document.getElementById('syntheticsContainer').style.display!=='none'; if(vis){ loadSynthMonitors(); loadSynthRuns(); } },7000); }
  function stopSynthTimer(){ if(synthTimer){ clearInterval(synthTimer); synthTimer=null; } }
  // Countdown logic
  let countdownTimer=null; function tickCountdown(){ const now=Date.now(); document.querySelectorAll('[data-countdown]').forEach(td=>{ const ts=Number(td.getAttribute('data-countdown')); if(!ts){ td.textContent=''; return; } const diff=ts-now; if(diff<=0){ td.textContent='due'; return; } const s=Math.floor(diff/1000); const m=Math.floor(s/60); const rem=s%60; td.textContent= m>0 ? `${m}m ${rem}s` : `${rem}s`; }); }
  function updateCountdowns(){ if(!countdownTimer){ countdownTimer=setInterval(()=>{ const vis=document.getElementById('syntheticsContainer').style.display!=='none'; if(!vis) return; tickCountdown(); },1000);} tickCountdown(); }
  function stopCountdowns(){ if(countdownTimer){ clearInterval(countdownTimer); countdownTimer=null; } }
  const btnSM=document.getElementById('refreshSynthMonitors'); if(btnSM) btnSM.addEventListener('click', loadSynthMonitors);
  const chkShowDel=document.getElementById('showDeletedSynth'); if(chkShowDel) chkShowDel.addEventListener('change', loadSynthMonitors);
  const btnSR=document.getElementById('refreshSynthRuns'); if(btnSR) btnSR.addEventListener('click', loadSynthRuns);
  document.getElementById('applyTraceFilters').addEventListener('click',()=>load(true));
  document.getElementById('prevPage').addEventListener('click',()=>{if(!traceState.serverCursors)return;traceState.cursor=traceState.serverCursors.prev;traceState.direction='next';load(false);});
  document.getElementById('nextPage').addEventListener('click',()=>{if(!traceState.serverCursors)return;traceState.cursor=traceState.serverCursors.next;traceState.direction='prev';load(false);});
  document.getElementById('exportTraceCsv').addEventListener('click',()=>exportTrace('csv'));
  document.getElementById('exportTraceJson').addEventListener('click',()=>exportTrace('json'));
  document.getElementById('exportTraceAllCsv').addEventListener('click',()=>exportAllTraces('csv'));
  document.getElementById('exportTraceAllJson').addEventListener('click',()=>exportAllTraces('json'));
  document.getElementById('traceHeaderRow').addEventListener('click',ev=>{const th=ev.target.closest('th');if(!th||!th.dataset.k)return;const k=th.dataset.k;if(traceState.sort.key===k){traceState.sort.dir=traceState.sort.dir==='asc'?'desc':'asc';}else{traceState.sort.key=k;traceState.sort.dir='asc';}load(false);});
      // Chat actions
  function drawChatBarChart(canvas, labels, values){
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        const w = canvas.clientWidth || canvas.width; const h = canvas.height; canvas.width = w; // fix blur
        ctx.clearRect(0,0,w,h);
        if(!labels.length || !values.length){ return; }
        const maxV = Math.max(1, ...values);
        const pad = 24; const barGap = 8;
        const n = values.length; const barW = Math.max(8, Math.floor((w - pad*2 - (n-1)*barGap)/n));
        // axes
        ctx.strokeStyle = '#334155'; ctx.beginPath(); ctx.moveTo(pad, h - pad); ctx.lineTo(w - 6, h - pad); ctx.moveTo(pad, h - pad); ctx.lineTo(pad, 6); ctx.stroke();
        // bars
        for(let i=0;i<n;i++){
          const v = values[i]; const x = pad + i*(barW+barGap); const bh = Math.round(((v/maxV) * (h - pad*2)));
          ctx.fillStyle = '#3b82f6'; ctx.fillRect(x, h - pad - bh, barW, bh);
          // labels (x)
          ctx.fillStyle = '#9ca3af'; ctx.font = '10px system-ui';
          const lbl = String(labels[i]);
          const tw = ctx.measureText(lbl).width;
          ctx.save(); ctx.translate(x + barW/2, h - pad + 12); ctx.rotate(-Math.PI/8);
          ctx.fillText(lbl, -tw/2, 0); ctx.restore();
          // values
          ctx.fillStyle = '#e5e7eb'; ctx.font = '11px system-ui';
          const val = String(v);
          const vw = ctx.measureText(val).width;
          ctx.fillText(val, x + barW/2 - vw/2, h - pad - bh - 4);
        }
      }

      let chatDiagramLastData = null;
      let chatLastSummary = null;
      let lastCalloutState = { level:null, ts:0 };
      const CALLOUT_THRESHOLDS = [
        { level:'severe', label:'Severe degradation', test: s=> (1 - s.sli) >= 0.25 || s.sli < 0.90, color:'#3a0e14', border:'#7f1d1d', fg:'#fb7185' },
        { level:'degraded', label:'Degraded — investigate', test: s=> s.sli < 0.96, color:'#3a0e14', border:'#7f1d1d', fg:'#fb7185' },
        { level:'moderate', label:'Moderate degradation', test: s=> s.sli < 0.98, color:'#3b2f07', border:'#92400e', fg:'#f59e0b' },
        { level:'slight', label:'SLA slightly degraded', test: s=> s.sli < 0.985, color:'#3b2f07', border:'#92400e', fg:'#f59e0b' },
        { level:'minor', label:'Minor blips', test: s=> s.sli < 0.99, color:'#0b1220', border:'#1f2937', fg:'#93c5fd' },
        { level:'healthy', label:'Healthy — within target', test: s=> s.sli < 0.995, color:'#073a2a', border:'#14532d', fg:'#34d399' },
        { level:'optimal', label:'SLA likely being met', test: s=> true, color:'#073a2a', border:'#14532d', fg:'#34d399' }
      ];
      function computeCallout(summary){
        try {
          const total = Number(summary?.totals?.total||0);
          const ok = Number(summary?.totals?.ok||0);
          const sli = Number(summary?.totals?.sli || (total ? ok/total : 1));
            const top = (summary?.errors||[])[0] || null;
          const errRate = 1 - sli;
                if (total < 30) return { text:'Low traffic — limited signal', level:'low', color:'#0b1220', border:'#1f2937', fg:'#93c5fd' };
                // High-priority patterns override (rate limiting / server errors) regardless of slight improvements
                if (top && String(top[0])==='429' && (top[1]/total)>=0.05) return { text:'Rate limiting observed', level:'rate', color:'#3b2f07', border:'#92400e', fg:'#f59e0b' };
                if (top && /^5\d\d$/.test(String(top[0])) && (top[1]/total)>=0.05) return { text:'Server errors elevated', level:'5xx', color:'#3a0e14', border:'#7f1d1d', fg:'#fb7185' };
                // Derive severity via ordered thresholds list
                for (const t of CALLOUT_THRESHOLDS) {
                  if (t.test({ sli, errRate, total })) {
                    return { text: t.label, level: t.level, color: t.color, border: t.border, fg: t.fg };
                  }
                }
                return null;
        } catch { return null; }
      }
      let legendBuilt = false;
      function buildLegend(){
        if (legendBuilt) return; legendBuilt = true;
        const body = document.getElementById('calloutLegendBody'); if(!body) return;
        const rows = [
          {label:'SLA likely being met', note:'SLI ≥ 99.5%'},
          {label:'Healthy — within target', note:'~99.0–99.5%'},
          {label:'Minor blips', note:'98.0–99.0%'},
          {label:'SLA slightly degraded', note:'98.5–99.0% (overrides minor)'},
          {label:'Moderate degradation', note:'96.0–98.0%'},
          {label:'Degraded — investigate', note:'90–96%'},
          {label:'Severe degradation', note:'< 90% or ≥25% errors'},
          {label:'Rate limiting observed', note:'429s ≥ 5%'},
          {label:'Server errors elevated', note:'5xx ≥ 5%'}
        ];
        body.innerHTML = rows.map(r=>`<div style="display:flex;flex-direction:column;"><span>${r.label}</span><span class='muted'>${r.note}</span></div>`).join('');
      }
      function showCallout(summary){
        const el=document.getElementById('chatCallout'); if(!el){return;}
        const textSpan=document.getElementById('chatCalloutText');
        const c=computeCallout(summary);
        if(!c){ el.style.display='none'; return; }
        const now = Date.now();
        const prev = lastCalloutState.level;
        const improving = prev && prev !== c.level; // change in level
        // Debounce improvements (only if better severity) for 3 refresh intervals (approx 6s) except worsening which is immediate
        const severityRank = lvl => ({optimal:0,healthy:1,minor:2,slight:3,moderate:4,degraded:5,severe:6,rate:5.5,'5xx':5.7,low:-1}[lvl] ?? 10);
        let allow = true;
        if (prev && c.level && severityRank(c.level) < severityRank(prev)) {
          // improvement
          if ((now - lastCalloutState.ts) < 6000) allow = false;
        }
        if(!allow){ return; }
        lastCalloutState = { level: c.level, ts: now };
        if(textSpan){ textSpan.textContent = c.text; }
        el.style.display='block'; el.style.background=c.color; el.style.borderColor=c.border; el.style.color=c.fg;
        buildLegend();
      }
      function hideCallout(){ const el=document.getElementById('chatCallout'); if(el){ el.style.display='none'; el.textContent=''; } }
      function buildSummaryText(summary){
        const lines=[]; if(!summary) return '';
        const sliPct=(Number(summary.totals?.sli||0)*100).toFixed(2)+'%';
        const errs=(summary.errors||[]).map(([k,v])=>`${k}: ${v}`).join(', ');
        lines.push(`Range: ${summary.range?.from||'—'} -> ${summary.range?.to||'—'}`);
        lines.push(`Endpoint: ${summary.endpoint||'all'}`);
        lines.push(`Totals: total=${summary.totals?.total??0}, ok=${summary.totals?.ok??0}, sli=${sliPct}`);
        lines.push(`Latency (ms): p50=${summary.latency?.p50??0}, p95=${summary.latency?.p95??0}, p99=${summary.latency?.p99??0}`);
        lines.push(`Top errors: ${errs||'—'}`);
        lines.push(`Tokens: prompt=${summary.tokens?.prompt??0}, completion=${summary.tokens?.completion??0}, total=${summary.tokens?.total??0}`);
        return lines.join('\n');
      }
      (function initCopySummary(){
        const btn=document.getElementById('copySummaryBtn'); if(!btn) return;
        btn.addEventListener('click', async ()=>{
          try{
            const text=buildSummaryText(chatLastSummary);
            if(!text){ btn.disabled=true; return; }
            await navigator.clipboard.writeText(text);
            btn.textContent='Copied'; setTimeout(()=>{ btn.textContent='Copy summary'; },1000);
          }catch(_){ btn.textContent='Copy failed'; setTimeout(()=>{ btn.textContent='Copy summary'; },1200); }
        });
      })();
  function renderAnswerSummary(summary){
        try{
          const ans = document.getElementById('chatAnswerSummary') || document.getElementById('chatAnswer');
          const meta = document.getElementById('chatAnswerMeta');
          const note = document.getElementById('noLlmNote');
          const copyBtn=document.getElementById('copySummaryBtn');
          if(!summary){ meta.textContent=''; ans.textContent='—'; hideCallout(); if(copyBtn) copyBtn.disabled=true; if(note) note.style.display='none'; return; }
          chatLastSummary = summary;
          const sli = Number(summary.totals?.sli||0);
          const sliPct = (sli*100).toFixed(2)+'%';
          const sliColor = sli>=0.995? '#34d399' : (sli>=0.98? '#f59e0b' : '#fb7185');
          const e = (summary.errors||[]);
          const errHtml = e.length ? e.map(([k,v])=>`<span class=\"pill\" style=\"margin:2px; display:inline-block;\">${k}: ${v}</span>`).join(' ') : '<span class=\"muted\">none</span>';
          const tPrompt = Number(summary.tokens?.prompt||0), tComp = Number(summary.tokens?.completion||0), tTot = Number(summary.tokens?.total||0);
          const h = `
            <div style="display:flex; flex-direction:column; gap:6px;">
              <div class="muted" style="font-size:12px;">${summary.range?.from || '—'} → ${summary.range?.to || '—'} • ${summary.endpoint || 'all'}</div>
              <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
                <span class="pill" style="background:${sliColor}; color:#0b0f14; font-weight:600;">SLI ${sliPct}</span>
                <span class="pill">Total ${summary.totals?.total ?? 0}</span>
                <span class="pill">OK ${summary.totals?.ok ?? 0}</span>
              </div>
              <div>
                <div class="muted" style="margin-bottom:4px;">Latency (ms)</div>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                  <span class="pill">p50 ${summary.latency?.p50 ?? 0}</span>
                  <span class="pill">p95 ${summary.latency?.p95 ?? 0}</span>
                  <span class="pill">p99 ${summary.latency?.p99 ?? 0}</span>
                </div>
              </div>
              <div>
                <div class="muted" style="margin-bottom:4px;">Top errors</div>
                <div>${errHtml}</div>
              </div>
              <div>
                <div class="muted" style="margin-bottom:4px;">Tokens</div>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                  <span class="pill">prompt ${tPrompt}</span>
                  <span class="pill">completion ${tComp}</span>
                  <span class="pill">total ${tTot}</span>
                </div>
              </div>
            </div>`;
          ans.innerHTML = h;
          showCallout(summary);
          if(copyBtn) copyBtn.disabled=false;
          meta.textContent = meta.textContent || '';
          // Note visibility now managed centrally via updateLlmUiState()
        }catch(_){ /* ignore */ }
      }

      // Unified UI state updater for LLM-related controls (badge, Ask LLM button, note)
      function updateLlmUiState(opts){
        try{
          const { usedLLM=false, hasSummary=false, lastQuery='' } = opts||{};
          const badge=document.getElementById('llmBadge'); if(badge){ badge.style.display = usedLLM ? 'inline-block':'none'; }
          const note=document.getElementById('noLlmNote'); if(note){ note.style.display = usedLLM ? 'none' : (hasSummary ? 'block':'none'); }
          const btn=document.getElementById('forceLlmBtn'); if(btn){ btn.style.display = (!usedLLM && hasSummary) ? 'inline-block':'none'; if(lastQuery) btn.dataset.lastQuery = lastQuery; }
        }catch(_){ }
      }

      function drawChatDiagram(data){
        const canvas = document.getElementById('chatDiagramCanvas');
        const empty = document.getElementById('chatDiagramEmpty');
        try {
          chatDiagramLastData = data || { tables: [] };
          const modeSel = document.getElementById('chatDiagramMode');
          const mode = (modeSel?.value || 'auto').toLowerCase();
          const tables = chatDiagramLastData.tables || [];
          let src = null;
          if (mode === 'auto') {
            const ctx = chatDiagramLastData.context || null;
            if (ctx && ctx.table) src = tables.find(t=>t.name===ctx.table) || null;
            if (!src) {
              src = tables.find(t=>t.name==='popular_models')
                 || tables.find(t=>t.name==='errors_by_status')
                 || tables.find(t=>t.name==='latency_by_endpoint')
                 || tables.find(t=>t.name==='lat_percentiles')
                 || tables.find(t=>t.name==='tokens_summary') || null;
            }
          } else if (mode === 'errors') src = tables.find(t=>t.name==='errors_by_status') || null;
          else if (mode === 'latency') src = tables.find(t=>t.name==='latency_by_endpoint') || tables.find(t=>t.name==='lat_percentiles') || null;
          else if (mode === 'tokens') src = tables.find(t=>t.name==='tokens_summary') || null;

          let labels = [], values = [];
          if (src && Array.isArray(src.rows)) {
            labels = src.rows.map(r => String(Array.isArray(r) ? r[0] : (r.key ?? '')));
            values = src.rows.map(r => Number(Array.isArray(r) ? r[1] : (r.value ?? 0)));
          }
          if (src && labels.length && values.length) {
            empty.style.display='none'; canvas.style.display='block'; drawChatBarChart(canvas, labels, values);
          } else { canvas.style.display='none'; empty.style.display='block'; }
        } catch(_) { canvas.style.display='none'; empty.style.display='block'; }
      }

      // React to diagram mode changes using the last data
      document.addEventListener('change', (e)=>{
        if (e.target && e.target.id === 'chatDiagramMode') {
          drawChatDiagram(chatDiagramLastData || { tables: [] });
        }
      });
      document.addEventListener('click',(e)=>{
        const btn = document.getElementById('calloutInfoBtn');
        const legend = document.getElementById('calloutLegend');
        if(!btn||!legend) return;
        if(e.target===btn){ legend.style.display = legend.style.display==='none' || !legend.style.display ? 'block':'none'; e.stopPropagation(); return; }
        if(!legend.contains(e.target)){ legend.style.display='none'; }
      });

      function setChatLoading(on){
        try{
          const sendBtn=document.getElementById('chatSend');
          const loadEl=document.getElementById('chatLoading');
          if(on){
            if(sendBtn){ sendBtn.disabled=true; sendBtn.dataset._orig=sendBtn.textContent; sendBtn.textContent='Sending…'; sendBtn.style.opacity='0.6'; }
            if(loadEl){ loadEl.style.display='flex'; }
          } else {
            if(sendBtn){ sendBtn.disabled=false; if(sendBtn.dataset._orig){ sendBtn.textContent=sendBtn.dataset._orig; } sendBtn.style.opacity='1'; }
            if(loadEl){ loadEl.style.display='none'; }
          }
        }catch(_){ }
      }

      // --- Conversation transcript state & helpers ---
      const chatHistory = [];
      // Load persisted chat history (best-effort)
      (function loadChatHistory(){
        try{
          const raw = localStorage.getItem('obs_chat_history_v1');
          if(raw){
            const arr = JSON.parse(raw);
            if(Array.isArray(arr)){
              arr.slice(-100).forEach(m=>{ if(m && typeof m==='object' && m.role && m.content){ chatHistory.push({ role: m.role==='assistant'?'assistant':'user', content: String(m.content).slice(0,1500), ts: m.ts||Date.now() }); } });
              renderChatHistory();
            }
          }
        }catch(_){ }
      })();
      function persistChatHistory(){
        try{
          const slim = chatHistory.slice(-120).map(m=>({ role:m.role, content:m.content.slice(0,2000), ts:m.ts }));
          localStorage.setItem('obs_chat_history_v1', JSON.stringify(slim));
        }catch(_){ }
      }
      function appendChatMessage(role, content){
        try{
          if(!content) return; const maxMessages=50; chatHistory.push({ role, content: String(content), ts: Date.now() });
          while(chatHistory.length > maxMessages) chatHistory.shift();
          renderChatHistory();
          persistChatHistory();
        }catch(_){ }
      }
      function renderChatHistory(){
        try{
          const list=document.getElementById('chatHistoryList'); if(!list) return;
          list.innerHTML='';
            chatHistory.slice(-80).forEach(m=>{
              const div=document.createElement('div');
              div.className='chatMsg';
              div.style.padding='4px 6px';
              div.style.borderBottom='1px solid #1e293b';
              div.style.fontSize='12px';
              div.style.whiteSpace='pre-wrap';
              const safe = mdEscapeHtml(m.content.slice(0,600));
              div.innerHTML = `<span style="font-weight:600;color:${m.role==='user'?'#93c5fd':'#34d399'};">${m.role}:</span> ${safe}`;
              list.appendChild(div);
            });
          list.scrollTop = list.scrollHeight;
        }catch(_){ }
      }
      function getChatHistoryPayload(){
        // Keep last 20 turns (role+content) truncated for context
        return chatHistory.slice(-20).map(m=>({ role: m.role==='assistant' ? 'assistant' : 'user', content: m.content.slice(0,1000) }));
      }

      async function chatSend(){
        if(chatSend._inFlight){ return; }
        const input=document.getElementById('chatInput');
        const txt=input.value.trim();
        if(!txt){ setChatLoading(false); return; }
        appendChatMessage('user', txt);
        input.value='';
        chatSend._inFlight = true;
        setChatLoading(true);
        const abs=absoluteRange(); const win=getWindow(); const now=Date.now();
        const from=abs?abs.from:(now-win*60000); const to=abs?abs.to:now;
        const ep=document.getElementById('endpointFilter').value;
  const llm=!!document.getElementById('chatUseLlm').checked;
        const modelSel = document.getElementById('chatModel');
        const chosenModel = modelSel ? (modelSel.value||'').trim() : '';
        const body={messages:getChatHistoryPayload(),from, to, filters:{ endpoint: (ep&&ep!=='__all__')?ep:null }, llm};
        if(chosenModel){ body.model = chosenModel; }
  const ansEl=document.getElementById('chatAnswer');
  const copyBtn=document.getElementById('copySummaryBtn');
  const narr=document.getElementById('chatNarrative'); if(narr){ narr.style.display='none'; narr.textContent=''; }
  const llmBadgeEl=document.getElementById('llmBadge'); if(llmBadgeEl){ llmBadgeEl.style.display='none'; }
  ansEl.textContent='';
  if(copyBtn) copyBtn.disabled=true;
  hideCallout();
  chatDiagramLastData = { tables: [] }; // clear diagram
  drawChatDiagram(chatDiagramLastData);
        // Try streaming endpoint first
        try{
          const r = await fetch('/ai/chat/stream',{ method:'POST', headers:{ 'content-type':'application/json' }, body: JSON.stringify(body) });
          if (!r.ok || !r.body) throw new Error('no stream');
          const reader = r.body.getReader(); const decoder = new TextDecoder();
          let ansBuffer = '';
          let leftover='';
          let usedLLMStream = false; // track if LLM path engaged
      while(true){
            const {value, done} = await reader.read(); if(done) break;
            leftover += decoder.decode(value,{stream:true});
            let idx;
            while((idx=leftover.indexOf('\n'))>=0){
              const line = leftover.slice(0,idx); leftover = leftover.slice(idx+1);
              if(!line.trim()) continue;
          try{const obj=JSON.parse(line); if(obj.delta!=null){ ansBuffer += String(obj.delta); if(!obj.done){ // live token display
                    const narrLive=document.getElementById('chatNarrative'); if(narrLive && document.getElementById('tabNarrative')?.classList.contains('active')){ narrLive.innerHTML = mdEscapeHtml(ansBuffer); }
                  }}
                if(obj.done){
                  if(obj.summary){
                    renderAnswerSummary(obj.summary);
                    if(obj.narrative){ narr.innerHTML = obj.usedLLM ? mdToHtml(obj.narrative) : mdEscapeHtml(obj.narrative); }
                  }
          if(obj.chartSpec){ renderChartSpec(obj.chartSpec); }
          if(obj.data){ chatDiagramLastData = obj.data; drawChatDiagram(chatDiagramLastData); }
          if(!obj.summary && obj.narrative){ narr.innerHTML = obj.usedLLM ? mdToHtml(obj.narrative) : mdEscapeHtml(obj.narrative); }
          if(obj.usedLLM){ usedLLMStream = true; }
          const metaEl=document.getElementById('chatAnswerMeta'); if(metaEl){
            const tried = obj.llmTried ? 'tried' : 'not tried';
            const used = obj.usedLLM ? 'used' : 'not used';
            const model = obj.llmModel ? ` • ${obj.llmModel}` : '';
            const status = (!obj.usedLLM && obj.llmStatus) ? ` • status ${obj.llmStatus}` : '';
            metaEl.textContent = `LLM ${used} (${tried})${model}${status}`;
          }
          appendChatMessage('assistant', (obj.narrative || ansBuffer || '').trim());
          updateLlmUiState({ usedLLM: !!obj.usedLLM, hasSummary: !!obj.summary, lastQuery: txt });
          persistChatHistory();
                }
              }catch(_){ /* ignore */ }
            }

            // (Removed duplicate tab initialization block - already initialized globally)

            // (Removed duplicate Ask LLM initializer; single global one remains)
          }
          // Post-process: if LLM used and we didn't replace with narrative earlier, render accumulated buffer as Markdown
          try{
            if(usedLLMStream){ narr.innerHTML = mdToHtml(ansBuffer.trim()); }
          }catch(_){ }
          setChatLoading(false); chatSend._inFlight=false;
          return;
        }catch(_){ /* fallback to non-stream */ }
        try{
          const r=await fetch('/ai/chat',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(body)});
          if(!r.ok){ansEl.textContent='Chat error ('+r.status+')';return;}
          const j=await r.json();
          if (j.summary){
            renderAnswerSummary(j.summary);
            if (j.narrative) { narr.innerHTML = j.usedLLM ? mdToHtml(j.narrative) : mdEscapeHtml(j.narrative); }
          } else {
            if (j.usedLLM && j.answer) { narr.innerHTML = mdToHtml(j.answer); } else { narr.textContent = j.answer || '(no answer)'; }
          }
          // Badge handled by unified updater
          if(j.chartSpec){ renderChartSpec(j.chartSpec); }
          // Evidence (grounding log snippets)
          try {
            const evBox=document.getElementById('chatEvidence');
            if(evBox){
              const ev=Array.isArray(j.evidence)?j.evidence:[];
              if(ev.length){
                evBox.style.display='block';
                evBox.innerHTML='<div style="font-weight:600;font-size:12px;margin-bottom:4px;">Evidence (logs)</div>'+ev.map(e=>{
                  const dt=new Date(e.ts||Date.now()).toISOString();
                  const meta=[dt,e.status||'',e.endpoint||'',e.model||'',e.region||''].filter(Boolean).join(' • ');
                  const safe=(e.text||'').replace(/[<>]/g,'');
                  return `<div class="ev-item" style="border:1px solid #243244;border-radius:6px;padding:6px;margin-bottom:6px;font-size:11px;">
                    <div style="color:#9ca3af;margin-bottom:4px;">${meta} <button data-text="${safe.replace(/"/g,'&quot;')}" class="btn ev-copy" style="float:right;font-size:10px;padding:2px 6px;">Copy</button></div>
                    <div style="white-space:pre-wrap;font-family:ui-monospace,monospace;">${safe}</div>
                  </div>`;
                }).join('');
                evBox.querySelectorAll('.ev-copy').forEach(btn=>{btn.addEventListener('click',()=>{try{navigator.clipboard.writeText(btn.getAttribute('data-text')||'');btn.textContent='Copied';setTimeout(()=>{btn.textContent='Copy';},1100);}catch(_){}});});
              } else { evBox.innerHTML=''; evBox.style.display='none'; }
            }
          }catch(_){ }
          chatDiagramLastData = j.data || { tables: [] };
          drawChatDiagram(chatDiagramLastData);
          appendChatMessage('assistant', (j.narrative || j.answer || '').trim());
          persistChatHistory();
          updateLlmUiState({ usedLLM: !!j.usedLLM, hasSummary: !!j.summary, lastQuery: txt });
          const metaEl=document.getElementById('chatAnswerMeta'); if(metaEl){
            const tried = j.llmTried ? 'tried' : 'not tried';
            const used = j.usedLLM ? 'used' : 'not used';
            const model = j.llmModel ? ` • ${j.llmModel}` : '';
            const status = (!j.usedLLM && j.llmStatus) ? ` • status ${j.llmStatus}` : '';
            metaEl.textContent = `LLM ${used} (${tried})${model}${status}`;
          }
          setChatLoading(false); chatSend._inFlight=false;
        }catch(e){ansEl.textContent='Chat failed'; setChatLoading(false); chatSend._inFlight=false;}
        finally { setChatLoading(false); chatSend._inFlight=false; }
      }

  // Initialize DB | LLM tabs (id tabSummary/tabNarrative)
      (function initAnswerTabs(){
        try{
          const tabS=document.getElementById('tabSummary');
          const tabN=document.getElementById('tabNarrative');
          const summaryEl=document.getElementById('chatAnswer');
            const narrEl=document.getElementById('chatNarrative');
          if(!tabS||!tabN||!summaryEl||!narrEl) return;
          function activate(which){
            if(which==='summary'){
              tabS.style.background='#1e293b'; tabS.style.color='#e5e7eb';
              tabN.style.background='transparent'; tabN.style.color='#9ca3af';
              summaryEl.style.display='block';
              narrEl.style.display='none';
            } else {
              tabN.style.background='#1e293b'; tabN.style.color='#e5e7eb';
              tabS.style.background='transparent'; tabS.style.color='#9ca3af';
              summaryEl.style.display='block'; // hide for clarity
              summaryEl.style.display='none';
              narrEl.style.display='block';
            }
          }
          tabS.addEventListener('click',()=>activate('summary'));
          tabN.addEventListener('click',()=>activate('narrative'));
          activate('summary');
        }catch(_){ }
      })();

      // Force LLM narrative generation button
      (function initForceLlmButton(){
        try{
          const btn=document.getElementById('forceLlmBtn'); if(!btn) return;
          btn.addEventListener('click',()=>{
            if(chatSend._inFlight) return; // prevent double trigger while sending
            const last=btn.dataset.lastQuery; if(!last) return;
            const input=document.getElementById('chatInput'); if(input){ input.value=last; }
            const llmBox=document.getElementById('chatUseLlm'); if(llmBox){ llmBox.checked=true; }
            chatSend();
            // Switch to Narrative tab (will populate after response)
            const tabN=document.getElementById('tabNarrative'); if(tabN) tabN.click();
            btn.style.display='none';
          });
        }catch(_){ }
      })();

      // --- chartSpec rendering (bar + pie) ---
      function renderChartSpec(spec){
        try{
          if(!spec || typeof spec !== 'object') return;
          const canvas=document.getElementById('chatDiagramCanvas'); if(!canvas) return;
          const empty=document.getElementById('chatDiagramEmpty'); if(empty) empty.style.display='none';
          canvas.style.display='block';
          if(spec.type==='bar' && Array.isArray(spec.x) && Array.isArray(spec.y)){
            drawChatBarChart(canvas, spec.x, spec.y); return;
          }
            if(spec.type==='pie' && Array.isArray(spec.series) && spec.series[0]){
              const s=spec.series[0];
              drawPieChart(canvas, s.labels, s.values, spec.title||'');
              return;
            }
        }catch(_){ }
      }
      function drawPieChart(canvas, labels, values, title){
        try{
          const ctx=canvas.getContext('2d'); const w=canvas.clientWidth||canvas.width; const h=canvas.height; canvas.width=w; ctx.clearRect(0,0,w,h);
          if(!labels || !labels.length) return;
          const total = values.reduce((a,b)=>a+(Number(b)||0),0)||1;
          const cx=w/2, cy=h/2; const radius=Math.min(w,h)/2 - 20; let start=-Math.PI/2;
          const palette=['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#06b6d4','#ec4899','#22c55e'];
          labels.forEach((lbl,i)=>{
            const val=Number(values[i]||0); const frac=val/total; const end=start+frac*Math.PI*2;
            ctx.beginPath(); ctx.moveTo(cx,cy); ctx.fillStyle=palette[i%palette.length]; ctx.arc(cx,cy,radius,start,end); ctx.closePath(); ctx.fill();
            const mid=(start+end)/2; const lx=cx+Math.cos(mid)*radius*0.6; const ly=cy+Math.sin(mid)*radius*0.6;
            ctx.fillStyle='#e5e7eb'; ctx.font='10px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(lbl, lx, ly);
            start=end;
          });
          if(title){ ctx.fillStyle='#e5e7eb'; ctx.font='12px system-ui'; ctx.textAlign='center'; ctx.fillText(title, cx, h-8); }
        }catch(_){ }
      }
      document.getElementById('chatSend').addEventListener('click',chatSend);
  const histClear=document.getElementById('chatHistoryClear'); if(histClear){ histClear.addEventListener('click',()=>{ chatHistory.length=0; persistChatHistory(); renderChatHistory(); }); }
  document.getElementById('chatClear').addEventListener('click',()=>{document.getElementById('chatInput').value='';document.getElementById('chatAnswer').textContent='—';document.getElementById('chatCitations').textContent='—';const ev=document.getElementById('chatEvidence');if(ev){ev.innerHTML='';ev.style.display='none';}});
      document.getElementById('chatInput').addEventListener('keydown',e=>{if(e.key==='Enter'&& (e.metaKey||e.ctrlKey)){e.preventDefault();chatSend();}});
  function getKey(){
    try{
      const v=localStorage.getItem('obs_ingest_key');
      return (v==null||v==='') ? 'secret' : v;
    }catch(_){ return 'secret'; }
  }
  function setKey(v){try{localStorage.setItem('obs_ingest_key',v||'');}catch(_){}}
  (function initKey(){
    const el=document.getElementById('chatKey');
    el.value=getKey();
    el.addEventListener('change',()=>{ setKey(el.value); window.__simTriedAutoStart=false; const st=document.getElementById('simAutoStatus'); if(st){ st.style.display='inline-block'; st.textContent='Re-checking simulator…'; } setTimeout(refreshSimButton,250); });
  })();
  // Populate model dropdown from /config
  (async function initModels(){
    try{
      const sel=document.getElementById('chatModel'); if(!sel) return;
      const r=await fetch('/config',{cache:'no-store'}); if(!r.ok) return; const j=await r.json();
      const models = Array.isArray(j.models)?j.models:[];
      const saved = (localStorage.getItem('obs_chat_model')||'').trim();
      models.forEach(m=>{ const opt=document.createElement('option'); opt.value=m; opt.textContent=m; sel.appendChild(opt); });
      if(saved && models.includes(saved)) sel.value=saved; else if(sel.options.length>0) { /* keep default */ }
      sel.addEventListener('change',()=>{ try{ localStorage.setItem('obs_chat_model', sel.value||''); }catch(_){ } });
    }catch(_){ }
  })();
  // Default enable LLM checkboxes unless user disabled previously
  (function initLlmPrefs(){
    try{
      const useEl=document.getElementById('chatUseLlm');
  const storedUse=localStorage.getItem('obs_chat_use_llm');
  if(storedUse==null){ useEl.checked=true; } else { useEl.checked = storedUse==='1'; }
  useEl.addEventListener('change',()=>{ try{ localStorage.setItem('obs_chat_use_llm', useEl.checked?'1':'0'); }catch(_){ } });
    }catch(_){ }
  })();
  async function runOp(url, method='GET'){
    const msg=document.getElementById('chatOpsMsg');msg.textContent='…';
    try{
      const headers={};const k=getKey();if(k) headers['x-api-key']=k;
      const r=await fetch(url,{method,headers});
      let json=null; try{ json = await r.clone().json(); }catch(_){ }
      if(r.ok){ msg.textContent='ok'; }
      else {
        const reason = (json && (json.error||json.detail)) ? (json.error||json.detail) : '';
        msg.textContent = 'err '+r.status + (reason? (' • '+reason):'');
      }
      setTimeout(()=>{msg.textContent='';},1200);
      return { ok:r.ok, status:r.status, json };
    }catch(_){ msg.textContent='err'; setTimeout(()=>{msg.textContent='';},1200); return { ok:false, status:0, json:null }; }
  }
  let simStatusSupported = true;
  async function refreshSimButton(){
    if(!simStatusSupported) return;
    try{
      const headers={};const k=getKey();if(k) headers['x-api-key']=k;
      const r=await fetch('/logs/sim/status',{headers,cache:'no-store'});
      if(!r.ok){
        if(r.status===404){ simStatusSupported=false; }
        if(r.status===401){
          const m=document.getElementById('chatOpsMsg'); m.textContent='Unauthorized: set ingest key'; setTimeout(()=>{m.textContent='';},1500);
          const st=document.getElementById('simAutoStatus'); if(st){ st.style.display='inline-block'; st.textContent='Simulator blocked: missing or invalid ingest key'; }
        }
        return;
      }
      const j=await r.json();
      const btn=document.getElementById('chatToggleSim');
      if(!btn) return;
      if(j.running){ btn.textContent='Stop simulator'; btn.classList.remove('btn-primary'); btn.classList.add('btn-danger'); btn.dataset.state='running'; }
      else { btn.textContent='Start log simulator'; btn.classList.remove('btn-danger'); btn.classList.add('btn-primary'); btn.dataset.state='stopped'; }
      // Auto-start if stopped (single attempt) and authorization OK
      if(!j.running){
        try{
          const autoFlag = window.__simTriedAutoStart || false;
          if(!autoFlag){
            window.__simTriedAutoStart = true;
            const res = await fetch('/logs/sim/start',{method:'POST',headers});
            if(res.ok){ const st=document.getElementById('simAutoStatus'); if(st){ st.style.display='none'; st.textContent=''; } setTimeout(refreshSimButton,400); }
            else { const st=document.getElementById('simAutoStatus'); if(st){ st.style.display='inline-block'; st.textContent='Auto-start failed ('+res.status+')'; } }
          }
        }catch(_){ }
      }
        const st=document.getElementById('simAutoStatus'); if(st){ st.style.display='none'; st.textContent=''; }
    }catch(_){ /* ignore */ }
  }
  async function toggleSim(){
    const btn=document.getElementById('chatToggleSim');
    const running=btn.dataset.state==='running';
    const url=running?'/logs/sim/stop':'/logs/sim/start';
    const res = await runOp(url);
    if(res.ok){
      // Update UI immediately based on action
      if(running){ btn.textContent='Start log simulator'; btn.classList.remove('btn-danger'); btn.classList.add('btn-primary'); btn.dataset.state='stopped'; }
      else { btn.textContent='Stop simulator'; btn.classList.remove('btn-primary'); btn.classList.add('btn-danger'); btn.dataset.state='running'; }
    }
  // Try to confirm via status if available
  if(simStatusSupported) setTimeout(refreshSimButton,300);
  // Refresh logs when changed
  setTimeout(refreshChatLogs,200);
  }
  document.getElementById('chatToggleSim').addEventListener('click',toggleSim);
  // Initialize button state on load
  refreshSimButton();
  // Fetch non-sensitive config and show auto-start notice if applicable
  (async function initConfig(){
    try{
      const r=await fetch('/config',{cache:'no-store'}); if(!r.ok) return; const j=await r.json();
      if(j && j.logSimEnabled){ const n=document.getElementById('simAutoNotice'); if(n) n.style.display='inline-block'; }
    }catch(_){ }
  })();
  // Embeddings auto-index toggle
  let indexStatusSupported = true;
  async function refreshIndexButton(){
    if(!indexStatusSupported) return;
    try{
      const headers={};const k=getKey();if(k) headers['x-api-key']=k;
      const r=await fetch('/ai/index/auto/status',{headers,cache:'no-store'});
      if(!r.ok){ if(r.status===404){ indexStatusSupported=false; } return; }
      const j=await r.json();
      const btn=document.getElementById('chatToggleIndex'); if(!btn) return;
      if(j.running){ btn.textContent='Disable auto-index'; btn.classList.remove('btn-accent'); btn.classList.add('btn-danger'); btn.dataset.state='running'; }
      else { btn.textContent='Enable auto-index'; btn.classList.remove('btn-danger'); btn.classList.add('btn-accent'); btn.dataset.state='stopped'; }
    }catch(_){ /* ignore */ }
  }
  async function toggleIndex(){
    const btn=document.getElementById('chatToggleIndex'); if(!btn) return;
    const running=btn.dataset.state==='running';
    const url=running?'/ai/index/auto/stop':'/ai/index/auto/start';
    const res=await runOp(url);
    if(res.ok){
      if(running){ btn.textContent='Enable auto-index'; btn.classList.remove('btn-danger'); btn.classList.add('btn-accent'); btn.dataset.state='stopped'; }
      else { btn.textContent='Disable auto-index'; btn.classList.remove('btn-accent'); btn.classList.add('btn-danger'); btn.dataset.state='running'; }
    }
    if(indexStatusSupported) setTimeout(refreshIndexButton,300);
  }
  document.getElementById('chatToggleIndex').addEventListener('click',toggleIndex);
  refreshIndexButton();

  // Load logs for Chat panel
  async function refreshChatLogs(){
    try{
      const abs=absoluteRange(); const win=getWindow(); const now=Date.now();
      const from=abs?abs.from:(now-win*60000); const to=abs?abs.to:now;
      const ep=document.getElementById('endpointFilter').value;
      const qp=new URLSearchParams(); qp.set('from',String(from)); qp.set('to',String(to)); qp.set('limit','100'); if(ep&&ep!=='__all__') qp.set('endpoint',ep);
      let items=[];
      const r=await fetch('/logs/list?'+qp.toString(),{cache:'no-store'});
      if(r.ok){ const j=await r.json(); items=j.items||[]; }
      else if(r.status===404){
        // Fallback to /logs/search with no query to get recent logs
        const s=await fetch('/logs/search?'+qp.toString()+'&k=100',{cache:'no-store'});
        if(s.ok){ const sj=await s.json(); items=(sj.items||[]).map(x=>({ id:x.id, ts:x.ts, endpoint:x.endpoint, model:x.model, region:x.region, status:x.status, text:x.text })); }
      } else { document.getElementById('chatLogsMeta').textContent='logs unavailable'; return; }
      const tbody=document.querySelector('#chatLogsTable tbody');
      tbody.innerHTML='';
      items.forEach(it=>{
        const tr=document.createElement('tr');
        const iso=new Date(it.ts).toISOString();
        tr.innerHTML=`<td style="padding:6px;border-bottom:1px solid #243244;">${iso}</td><td style="padding:6px;border-bottom:1px solid #243244;">${it.status??''}</td><td style="padding:6px;border-bottom:1px solid #243244;">${it.endpoint}</td><td style="padding:6px;border-bottom:1px solid #243244;">${it.model||''}</td><td style="padding:6px;border-bottom:1px solid #243244;">${it.region||''}</td><td style="padding:6px;border-bottom:1px solid #243244;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:600px;">${(it.text||'').replace(/[<>]/g,'')}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('chatLogsMeta').textContent=`${items.length} logs`;
    }catch(e){ document.getElementById('chatLogsMeta').textContent='logs error'; }
  }
  // Periodically refresh logs when Chat tab is visible
  let chatLogsTimer=null;
  function startChatLogsTimer(){ if(chatLogsTimer) return; chatLogsTimer=setInterval(()=>{ const chatVisible=document.getElementById('chatContainer').style.display!=='none'; if(chatVisible) refreshChatLogs(); },5000); }
  function stopChatLogsTimer(){ if(chatLogsTimer){ clearInterval(chatLogsTimer); chatLogsTimer=null; } }
      // Prefilled reasons & templates
      const REASON_PROMPTS={
        triage:'Triage the current window: summarize SLI, top failing statuses, affected endpoints, and immediate next steps to mitigate.',
        correlate:'Correlate error and latency spikes with model/region/endpoint; identify the strongest contributors and co-occurring signals.',
        rca:'Perform a brief root cause analysis: what changed, what dimensions correlate most with failures, and what likely root causes emerge?',
        visualize:'Propose a quick visualization (axes, buckets) to reveal the issue: e.g., errors by status over 5-min buckets or latency p95 by region.',
        cost:'Analyze any cost spikes: which endpoints/models are driving tokens and $; highlight outliers vs typical baseline.',
        perf:'Identify performance regressions: which cohort shows higher latency; quantify p50/p95 delta and likely cause.',
        anomaly:'Detect anomalies in the selected window: error bursts or unusual patterns; cite the top suspicious logs.',
        security:'Audit/security: list unusual access or error patterns (e.g., many 401/403), and any sensitive error messages to review.',
        usage:'Summarize usage trends: volume, success rate, and token usage by endpoint/model; highlight changes from prior window.',
        canary:'Compare baseline vs canary cohorts for errors, latency and cost; provide deltas and a simple recommendation.'
      };
      const TEMPLATES=[
        { label:'Summary: reliability snapshot', text:'Summarize reliability over the current range, including SLI, p50/p95/p99, top error statuses, affected endpoints, and a brief recommendation.' },
        { label:'Why did errors spike?', text:'Explain any error spikes in the current window. Show likely causes, top error types/status codes with counts, and which endpoints/models are impacted.' },
        { label:'Correlation by model/region', text:'Correlate latency and failures with model and region. Which combinations contribute most to p95 and error rate?' },
        { label:'Top slow requests', text:'List the top 10 slowest successful requests with context (status, endpoint, model, region), and any common patterns.' },
        { label:'Rate limits (429) analysis', text:'Find and summarize logs related to 429 rate limits in this window. Include messages and any request patterns contributing to throttling.' },
        { label:'Error distribution over time', text:'Describe an error distribution by status code over time (e.g., 5-min buckets). Provide key inflection points and possible triggers.' },
        { label:'Cost & tokens outliers', text:'Summarize cost and tokens by endpoint/model; call out any outliers or abrupt changes compared to typical behavior.' },
        { label:'Baseline vs Canary', text:'Compare baseline vs canary cohorts for latency (p50/p95) and errors. Provide deltas, and whether canary is acceptable.' },
        { label:'Anomalous patterns', text:'Identify anomalous request patterns or unusual sequences in the current window; include the most relevant logs as evidence.' },
        { label:'Draft incident report', text:'Draft a concise incident summary for this window: impact, timeline, suspected cause, and action items.' }
      ];
      (function initChatPrompts(){
        const reason=document.getElementById('chatReason');
        const tpl=document.getElementById('chatTemplates');
        // Fill templates
        TEMPLATES.forEach((t,i)=>{const o=document.createElement('option');o.value=String(i);o.textContent=t.label;tpl.appendChild(o);});
        reason.addEventListener('change',()=>{const key=reason.value; if(!key) return; const txt=REASON_PROMPTS[key]; if(txt){ const input=document.getElementById('chatInput'); input.value=txt; input.focus(); }});
        tpl.addEventListener('change',()=>{const idx=Number(tpl.value); if(Number.isInteger(idx)){ const t=TEMPLATES[idx]; if(t){ const input=document.getElementById('chatInput'); input.value=t.text; input.focus(); }}});
  // Persist LLM toggle
  const llmBox=document.getElementById('chatUseLlm');
  try{ llmBox.checked = localStorage.getItem('obs_chat_llm')==='1'; }catch(_){ llmBox.checked=false; }
  llmBox.addEventListener('change',()=>{ try{ localStorage.setItem('obs_chat_llm', llmBox.checked?'1':'0'); }catch(_){ } });
      })();
      // ===== UI Enhancements logic =====
      const PRICING={"gpt-4o-mini":{prompt:0.000150,completion:0.000600},"gpt-4.1-nano":{prompt:0.000030,completion:0.000060},"omni-moderation-latest":{prompt:0.000050,completion:0},"text-embedding-3-small":{prompt:0.000020,completion:0},"default":{prompt:0.000100,completion:0.000200}};
  const cmpSelect=document.getElementById('cmpSelect');const cmpValues=document.getElementById('cmpValues');const cmpValuesContainer=document.getElementById('cmpValuesContainer');const baselineCanaryControls=document.getElementById('baselineCanaryControls');const sloTargetSelect=document.getElementById('sloTargetSelect');const sloTargetCustom=document.getElementById('sloTargetCustom');const toggleIncidents=document.getElementById('toggleIncidents');
  const sliValue=document.getElementById('sliValue');const sliMeta=document.getElementById('sliMeta');const ebrValue=document.getElementById('ebrValue');const ebrMeta=document.getElementById('ebrMeta');const ebrBar=document.getElementById('ebrBar');const burnRateSpark=document.getElementById('burnRateSpark');const burnRateLegend=document.getElementById('burnRateLegend');const latencyTimeseries=document.getElementById('latencyTimeseries');const incidentOverlay=document.getElementById('incidentOverlay');const latencyHeatmap=document.getElementById('latencyHeatmap');const errorHeatmap=document.getElementById('errorHeatmap');const tokensArea=document.getElementById('tokensArea');const costLine=document.getElementById('costLine');
  const latencyLegend=document.getElementById('latencyLegend');
  const costLegend=document.getElementById('costLegend');
  const costCompareSummary=document.getElementById('costCompareSummary');
  const costCompareContainer=document.getElementById('costCompareContainer');
      function statusOk(s){return s>=200&&s<300;}function fmtPct(x){return (x*100).toFixed(2)+'%';}function clamp01(x){return Math.max(0,Math.min(1,x));}
      async function fetchIncidents(from,to){if(!toggleIncidents||!toggleIncidents.checked) return [];try{const p=new URLSearchParams();if(from)p.set('from',String(from));if(to)p.set('to',String(to));const r=await fetch('/incidents?'+p.toString(),{cache:'no-store'});if(r.ok)return await r.json();}catch(_){}try{const r=await fetch('/incidents.json',{cache:'no-store'});if(r.ok){const all=await r.json();if(!from||!to)return all;return all.filter(x=>x.end>=from&&x.start<=to);}}catch(_){}return []}
      async function fetchAllTracesForRange(endpoint,from,to,limit=500,maxPages=30){let cursor=null;let all=[];let pages=0;while(pages<maxPages){const qp=new URLSearchParams();if(endpoint&&endpoint!=='__all__') qp.set('endpoint',endpoint);if(from) qp.set('from',String(from));if(to) qp.set('to',String(to));qp.set('limit',String(limit));if(cursor){qp.set('cursor',String(cursor));qp.set('direction','prev');}const r=await fetch('/traces?'+qp.toString(),{cache:'no-store'});if(!r.ok) break;const j=await r.json();const pts=j.points||[];all=all.concat(pts);pages++;if(!j.cursor||!j.cursor.next||pts.length<limit) break;cursor=j.cursor.next; if(from && pts.some(p=>p.ts<=from)) break;}
        return all.filter(p=>(!from||p.ts>=from)&&(!to||p.ts<=to));}
      function bucketize(traces,from,to,buckets=60,groupBy){if(!from||!to||to<=from) return {step:0,series:[]};const step=Math.max(1,Math.floor((to-from)/buckets));const keyFor=(t)=>{if(!groupBy||!groupBy.length) return 'all';return groupBy.map(k=>t[k]||'').join('|');};const m=new Map();for(const t of traces){const idx=Math.min(buckets-1,Math.max(0,Math.floor((t.ts-from)/step)));const key=keyFor(t);if(!m.has(key)) m.set(key,Array(buckets).fill(null).map((_,i)=>({t:from+i*step,latencies:[],statusCounts:{},ok:0,total:0,tokensPrompt:0,tokensCompletion:0,tokensTotal:0})));const b=m.get(key)[idx];if(typeof t.latencyMs==='number') b.latencies.push(t.latencyMs);const sKey=String(t.status??(t.ok?200:0));b.statusCounts[sKey]=(b.statusCounts[sKey]||0)+1;b.total+=1;if(statusOk(t.status??(t.ok?200:0))) b.ok+=1;b.tokensPrompt+=(t.tokensPrompt||0);b.tokensCompletion+=(t.tokensCompletion||0);b.tokensTotal+=(t.tokensTotal||0);}function perc(a,p){if(!a.length)return null;const s=a.slice().sort((x,y)=>x-y);const idx=Math.min(s.length-1,Math.max(0,Math.floor((p/100)*(s.length-1))));return s[idx];}const out=[];for(const [k,arr] of m.entries()){out.push({key:k,points:arr.map(b=>({t:b.t,count:b.total,ok:b.ok,p50:perc(b.latencies,50),p75:perc(b.latencies,75),p90:perc(b.latencies,90),p95:perc(b.latencies,95),p99:perc(b.latencies,99),statusCounts:b.statusCounts,tokensPrompt:b.tokensPrompt,tokensCompletion:b.tokensCompletion,tokensTotal:b.tokensTotal}))});}return {step,series:out};}
      function computeSLI(series){let ok=0,total=0;for(const s of series){for(const p of s.points){ok+=p.ok;total+=p.count;}}return {ok,total,sli:total?ok/total:1};}
  function getCurrentCohort(){const ep=document.getElementById('endpointFilter').value;const abs=absoluteRange();const win=getWindow();const now=Date.now();return abs?{endpoint:ep,from:abs.from,to:abs.to}:{endpoint:ep,from:now-win*60000,to:now};}
  function saveCohort(name){try{const cfg=getCurrentCohort();localStorage.setItem(name,JSON.stringify(cfg));}catch(e){console.error('save cohort failed',e);}}
  function loadCohort(name){try{const v=localStorage.getItem(name);return v?JSON.parse(v):null;}catch(_){return null;}}
  function drawBurn(ctx,points,target){const w=ctx.canvas.clientWidth||ctx.canvas.width,h=ctx.canvas.height;ctx.canvas.width=w;ctx.clearRect(0,0,w,h);if(!points.length){chartState.burn=null;return;}const errs=points.map(p=>p.total?1-(p.ok/p.total):0);const denom=Math.max(1e-6,1-target);const burns=errs.map(e=>e/denom);const maxB=Math.max(1,...burns);ctx.strokeStyle='#666';ctx.beginPath();ctx.moveTo(0,h-0.5);ctx.lineTo(w,h-0.5);ctx.stroke();ctx.setLineDash([4,3]);ctx.strokeStyle='#888';const y1=h-(1/maxB)*h;ctx.beginPath();ctx.moveTo(0,y1);ctx.lineTo(w,y1);ctx.stroke();ctx.setLineDash([]);ctx.strokeStyle='#3b82f6';ctx.beginPath();burns.forEach((b,i)=>{const x=(i/(burns.length-1))*(w-1),y=h-(b/maxB)*(h-1);if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);});ctx.stroke();document.getElementById('burnRateLegend').textContent=`max ${Math.max(...burns).toFixed(2)} • target ${ (target*100).toFixed(2)}%`;chartState.burn={points,target,burns,maxB};}
  function labelChart(ctx,text){ctx.save();ctx.fillStyle='#9ca3af';ctx.font='10px system-ui';ctx.fillText(text,4,11);ctx.restore();}
  function drawBurnLabeled(ctx,points,target){drawBurn(ctx,points,target);labelChart(ctx,'burn-rate');}
      function drawLatency(ctx,series,overlays){const w=ctx.canvas.clientWidth||ctx.canvas.width,h=ctx.canvas.height;ctx.canvas.width=w;ctx.clearRect(0,0,w,h);if(!series.length)return;const pts=series.flatMap(s=>s.points);const tMin=Math.min(...pts.map(p=>p.t));const tMax=Math.max(...pts.map(p=>p.t));const yMax=Math.max(1,...pts.flatMap(p=>[p.p50||0,p.p95||0]));const colors=['#3b82f6','#ef8f00','#22c55e','#a855f7','#06b6d4','#ef4444'];series.forEach((s,si)=>{[['p50',0],['p95',1]].forEach(([k,off])=>{const c=colors[(si*2+off)%colors.length];ctx.strokeStyle=c;ctx.beginPath();s.points.forEach((p,i)=>{const x=(p.t-tMin)/(tMax-tMin||1)*(w-1);const y=h-((p[k]||0)/yMax)*(h-1);if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);});ctx.stroke();});});labelChart(ctx,'ms');const oCanvas=document.getElementById('incidentOverlay');const octx=oCanvas.getContext('2d');oCanvas.width=w;oCanvas.height=h;octx.clearRect(0,0,w,h);if(toggleIncidents&&toggleIncidents.checked&&overlays&&overlays.length){octx.fillStyle='rgba(239,68,68,0.12)';overlays.forEach(inc=>{const x1=(Math.max(inc.start,tMin)-tMin)/(tMax-tMin||1)*(w-1);const x2=(Math.min(inc.end,tMax)-tMin)/(tMax-tMin||1)*(w-1);if(x2>=0&&x1<=w)octx.fillRect(Math.max(0,x1),0,Math.max(1,x2-x1),h);});}
        // store for hover
        chartState.latency={series,overlays,domain:{tMin,tMax},yMax};}
      function drawHeatLatency(ctx,series){const w=ctx.canvas.clientWidth||ctx.canvas.width,h=ctx.canvas.height;ctx.canvas.width=w;ctx.clearRect(0,0,w,h);if(!series.length)return;const pts=series[0].points;const rows=['p50','p75','p90','p95','p99'];const cols=pts.length;const maxV=Math.max(1,...pts.flatMap(p=>rows.map(r=>p[r]||0)));const cw=Math.max(1,Math.floor(w/cols)),ch=Math.max(1,Math.floor(h/rows.length));for(let c=0;c<cols;c++){for(let r=0;r<rows.length;r++){const v=pts[c][rows[r]]||0;const t=v/maxV;const col=`hsl(${(1-t)*120},70%,45%)`;ctx.fillStyle=col;ctx.fillRect(c*cw,r*ch,cw,ch);}}}
      function drawHeatErrors(ctx,series){const w=ctx.canvas.clientWidth||ctx.canvas.width,h=ctx.canvas.height;ctx.canvas.width=w;ctx.clearRect(0,0,w,h);if(!series.length)return;const pts=series[0].points;const statuses=Array.from(new Set(pts.flatMap(p=>Object.keys(p.statusCounts||{})))).sort();if(!statuses.length)return;const cols=pts.length;const cw=Math.max(1,Math.floor(w/cols)),ch=Math.max(1,Math.floor(h/statuses.length));const maxC=Math.max(1,...pts.flatMap(p=>statuses.map(s=>p.statusCounts[s]||0)));for(let c=0;c<cols;c++){for(let r=0;r<statuses.length;r++){const s=statuses[r];const v=pts[c].statusCounts[s]||0;const t=v/maxC;const col=v===0?'rgba(255,255,255,0.03)':`hsl(${(1-t)*120},70%,40%)`;ctx.fillStyle=col;ctx.fillRect(c*cw,r*ch,cw,ch);}}}
    function usd(model,prompt,completion){const p=PRICING[model]||PRICING.default;return (prompt/1000)*p.prompt+(completion/1000)*p.completion;}
  function fmtInt(n){return (n||0).toLocaleString();}
  function fmtUsd(n){return '$'+(n||0).toFixed(4);}
  function computeCostAgg(traces){const agg=new Map();let totalPrompt=0,totalComp=0,totalUsd=0;for(const t of traces){const ep=t.endpoint||'unknown';const model=t.model||'default';const k=ep+'||'+model;const prompt=Number(t.tokensPrompt||0);const comp=Number(t.tokensCompletion||0);const tot=Number(t.tokensTotal||prompt+comp);if(!agg.has(k)) agg.set(k,{endpoint:ep,model,prompt:0,completion:0,total:0,usd:0});const row=agg.get(k);row.prompt+=prompt;row.completion+=comp;row.total+=tot;row.usd+=usd(model,prompt,comp);totalPrompt+=prompt;totalComp+=comp;totalUsd+=usd(model,prompt,comp);}const rows=[...agg.values()].sort((a,b)=>b.usd-a.usd);return {rows,totalPrompt,totalComp,totalUsd};}
  function drawTokens(ctx,series){const w=ctx.canvas.clientWidth||ctx.canvas.width,h=ctx.canvas.height;ctx.canvas.width=w;ctx.clearRect(0,0,w,h);if(!series.length){chartState.tokens=null;return;}const pts=series[0].points;const maxT=Math.max(1,...pts.map(p=>(p.tokensPrompt+p.tokensCompletion)));const prompt=(i)=>pts[i].tokensPrompt,comp=(i)=>pts[i].tokensCompletion;function area(vals,color,offset){ctx.fillStyle=color;ctx.beginPath();for(let i=0;i<pts.length;i++){const x=(i/(pts.length-1))*(w-1);const v=vals(i),o=offset?offset(i):0;const y=h-((v+o)/maxT)*(h-1);if(i===0)ctx.moveTo(x,h-(o/maxT)*(h-1));ctx.lineTo(x,y);}for(let i=pts.length-1;i>=0;i--){const x=(i/(pts.length-1))*(w-1);const o=offset?offset(i):0;const y=h-(o/maxT)*(h-1);ctx.lineTo(x,y);}ctx.closePath();ctx.fill();}
  area(prompt,'rgba(59,130,246,0.35)');area(comp,'rgba(34,197,94,0.35)',prompt);labelChart(ctx,'tokens');chartState.tokens={pts,maxT};}
      function drawCost(ctx,series,modelLabel){const w=ctx.canvas.clientWidth||ctx.canvas.width,h=ctx.canvas.height;ctx.canvas.width=w;ctx.clearRect(0,0,w,h);if(!series.length){chartState.cost=null;return;}const pts=series[0].points;const stepArr=pts.map(p=>usd(modelLabel,p.tokensPrompt,p.tokensCompletion));let cum=0;const cumArr=stepArr.map(v=>{cum+=v;return cum;});const maxU=Math.max(1e-6,cumArr[cumArr.length-1]);ctx.strokeStyle='#e91e63';ctx.beginPath();for(let i=0;i<pts.length;i++){const x=(i/(pts.length-1))*(w-1);const y=h-(cumArr[i]/maxU)*(h-1);if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);}ctx.stroke();labelChart(ctx,'$ (cum)');chartState.cost={pts,model:modelLabel,stepArr,cumArr,maxU};}
      // ===== Hover interaction helpers =====
      const chartState={latency:null,burn:null,tokens:null,cost:null};
      function clearAndRedrawLatencyHover(ix){if(!chartState.latency) return;const {series,overlays,domain:{tMin,tMax},yMax}=chartState.latency;const ctx=latencyTimeseries.getContext('2d');drawLatency(ctx,series,overlays);if(ix==null) return;const w=latencyTimeseries.clientWidth||latencyTimeseries.width;const h=latencyTimeseries.height;const octx=incidentOverlay.getContext('2d');octx.clearRect(0,0,w,h); // redraw incidents
        if(toggleIncidents&&toggleIncidents.checked&&overlays&&overlays.length){octx.fillStyle='rgba(239,68,68,0.12)';overlays.forEach(inc=>{const x1=(Math.max(inc.start,tMin)-tMin)/(tMax-tMin||1)*(w-1);const x2=(Math.min(inc.end,tMax)-tMin)/(tMax-tMin||1)*(w-1);if(x2>=0&&x1<=w)octx.fillRect(Math.max(0,x1),0,Math.max(1,x2-x1),h);});}
        // vertical line
        const x=(ix/((series[0]?.points?.length||1)-1))*(w-1);
        octx.strokeStyle='rgba(255,255,255,0.4)';octx.beginPath();octx.moveTo(x,0);octx.lineTo(x,h);octx.stroke();
        // tooltip
        const tt=[];const tVal=series[0]?.points?.[ix]?.t; if(tVal){tt.push(new Date(tVal).toLocaleTimeString());}
        series.forEach((s,si)=>{const p=s.points[ix];if(!p) return;tt.push(`${s.key||'all'} p50=${p.p50??'–'}ms p95=${p.p95??'–'}ms`);});
        drawTooltip(octx,Math.min(w-4,Math.max(4,x+8)),12,tt);
      }
      function drawTooltip(ctx,x,y,lines){const pad=6;ctx.save();ctx.font='11px system-ui';const w=Math.max(...lines.map(t=>ctx.measureText(t).width))+pad*2;const h=lines.length*14+pad*2;ctx.fillStyle='rgba(0,0,0,0.7)';ctx.fillRect(x,y,w,h);ctx.strokeStyle='rgba(255,255,255,0.2)';ctx.strokeRect(x+0.5,y+0.5,w-1,h-1);ctx.fillStyle='#e5e7eb';lines.forEach((t,i)=>ctx.fillText(t,x+pad,y+pad+12+ i*14));ctx.restore();}
      function enableHoverLatency(){const canvas=latencyTimeseries;canvas.addEventListener('mousemove',ev=>{if(!chartState.latency)return;const rect=canvas.getBoundingClientRect();const w=canvas.clientWidth||canvas.width;const n=chartState.latency.series[0]?.points?.length||0; if(!n) return;const x=Math.min(Math.max(0,ev.clientX-rect.left),w-1);const ix=Math.round((x/(w-1))*(n-1));clearAndRedrawLatencyHover(ix);});canvas.addEventListener('mouseleave',()=>clearAndRedrawLatencyHover(null));}
      function enableHoverBurn(){const canvas=burnRateSpark;canvas.addEventListener('mousemove',ev=>{const w=canvas.clientWidth||canvas.width;const h=canvas.height;const rect=canvas.getBoundingClientRect();const x=Math.min(Math.max(0,ev.clientX-rect.left),w-1);const n=chartState.burn?.burns?.length||0;if(!n)return;const ix=Math.round((x/(w-1))*(n-1));drawBurnLabeled(canvas.getContext('2d'),chartState.burn.points,chartState.burn.target);const v=chartState.burn.burns[ix];const y=Math.max(0,h-(v/chartState.burn.maxB)*(h-1));const ctx=canvas.getContext('2d');ctx.strokeStyle='rgba(255,255,255,0.4)';ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke();drawTooltip(ctx,Math.min(w-4,x+8),8,[`burn ${v.toFixed(2)}`]);});canvas.addEventListener('mouseleave',()=>{if(chartState.burn) drawBurnLabeled(canvas.getContext('2d'),chartState.burn.points,chartState.burn.target);});}
      function enableHoverTokens(){const canvas=tokensArea;canvas.addEventListener('mousemove',ev=>{if(!chartState.tokens) return;const {pts,maxT}=chartState.tokens;const w=canvas.clientWidth||canvas.width;const h=canvas.height;const rect=canvas.getBoundingClientRect();const x=Math.min(Math.max(0,ev.clientX-rect.left),w-1);const n=pts.length;const ix=Math.round((x/(w-1))*(n-1));drawTokens(canvas.getContext('2d'),[{points:pts}]);const p=pts[ix];const total=(p.tokensPrompt||0)+(p.tokensCompletion||0);const y=h-((total/maxT)*(h-1));const ctx=canvas.getContext('2d');ctx.strokeStyle='rgba(255,255,255,0.4)';ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke();drawTooltip(ctx,Math.min(w-4,x+8),8,[`prompt ${fmtInt(p.tokensPrompt||0)}`,`completion ${fmtInt(p.tokensCompletion||0)}`,`total ${fmtInt(total)}`]);});canvas.addEventListener('mouseleave',()=>{if(chartState.tokens) drawTokens(canvas.getContext('2d'),[{points:chartState.tokens.pts}]);});}
      function enableHoverCost(){const canvas=costLine;canvas.addEventListener('mousemove',ev=>{if(!chartState.cost) return;const {pts,model,stepArr,cumArr,maxU}=chartState.cost;const w=canvas.clientWidth||canvas.width;const h=canvas.height;const rect=canvas.getBoundingClientRect();const x=Math.min(Math.max(0,ev.clientX-rect.left),w-1);const n=pts.length;const ix=Math.round((x/(w-1))*(n-1));drawCost(canvas.getContext('2d'),[{points:pts}],model);const cum=cumArr[ix];const y=h-((cum/maxU)*(h-1));const ctx=canvas.getContext('2d');ctx.strokeStyle='rgba(255,255,255,0.4)';ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke();drawTooltip(ctx,Math.min(w-4,x+8),8,[`cum ${fmtUsd(cum)}`,`step ${fmtUsd(stepArr[ix])}`]);});canvas.addEventListener('mouseleave',()=>{if(chartState.cost) drawCost(canvas.getContext('2d'),[{points:chartState.cost.pts}],chartState.cost.model);});}
  function populateCompareValues(traces){const mode=cmpSelect.value;if(mode==='none'||mode==='baseline') return;const key=mode==='model'?'model':'region';const vals=Array.from(new Set(traces.map(t=>t[key]).filter(Boolean))).sort();cmpValues.innerHTML='';vals.forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v;cmpValues.appendChild(o);});}
  function populateCostTable(traces){costCompareSummary.style.display='none';costCompareContainer.style.display='none';document.querySelector('#costBreakdownTable').parentElement.style.display='block';const tbody=document.querySelector('#costBreakdownTable tbody');tbody.innerHTML='';if(!traces||!traces.length){const tr=document.createElement('tr');tr.innerHTML='<td colspan="6" class="muted" style="padding:6px;">No token data</td>';tbody.appendChild(tr);costLegend.textContent='Stacked tokens + $ line';return;}const {rows,totalPrompt,totalComp,totalUsd}=computeCostAgg(traces);for(const r of rows){const tr=document.createElement('tr');tr.innerHTML=`<td style=\"padding:6px;\">${r.endpoint}</td><td style=\"padding:6px;\">${r.model}</td><td style=\"padding:6px;text-align:right;\">${fmtInt(r.prompt)}</td><td style=\"padding:6px;text-align:right;\">${fmtInt(r.completion)}</td><td style=\"padding:6px;text-align:right;\">${fmtInt(r.total)}</td><td style=\"padding:6px;text-align:right;\">${fmtUsd(r.usd)}</td>`;tbody.appendChild(tr);}const tr=document.createElement('tr');tr.innerHTML=`<td colspan=\"2\" style=\"padding:6px;text-align:right;border-top:1px solid #243244;\"><strong>Total</strong></td><td style=\"padding:6px;text-align:right;border-top:1px solid #243244;\"><strong>${fmtInt(totalPrompt)}</strong></td><td style=\"padding:6px;text-align:right;border-top:1px solid #243244;\"><strong>${fmtInt(totalComp)}</strong></td><td style=\"padding:6px;text-align:right;border-top:1px solid #243244;\"><strong>${fmtInt(totalPrompt+totalComp)}</strong></td><td style=\"padding:6px;text-align:right;border-top:1px solid #243244;\"><strong>${fmtUsd(totalUsd)}</strong></td>`;tbody.appendChild(tr);costLegend.textContent=`Total tokens: ${fmtInt(totalPrompt+totalComp)} • Total approx: ${fmtUsd(totalUsd)}`;}
  function populateCostCompare(baseTr,canTr){const baseAgg=computeCostAgg(baseTr);const canAgg=computeCostAgg(canTr);document.querySelector('#costBreakdownTable').parentElement.style.display='none';costCompareContainer.style.display='flex';costCompareSummary.style.display='block';const summary=`Baseline ${fmtUsd(baseAgg.totalUsd)} • ${fmtInt(baseAgg.totalPrompt+baseAgg.totalComp)} tok  |  Canary ${fmtUsd(canAgg.totalUsd)} • ${fmtInt(canAgg.totalPrompt+canAgg.totalComp)} tok  |  Δ ${fmtUsd(canAgg.totalUsd-baseAgg.totalUsd)} • ${fmtInt((canAgg.totalPrompt+canAgg.totalComp)-(baseAgg.totalPrompt+baseAgg.totalComp))} tok`;
    costCompareSummary.textContent=summary;function fill(tableId,rows,tot){const tbody=document.querySelector(`#${tableId} tbody`);tbody.innerHTML='';for(const r of rows){const tr=document.createElement('tr');tr.innerHTML=`<td style=\"padding:6px;\">${r.endpoint}</td><td style=\"padding:6px;\">${r.model}</td><td style=\"padding:6px;text-align:right;\">${fmtInt(r.prompt)}</td><td style=\"padding:6px;text-align:right;\">${fmtInt(r.completion)}</td><td style=\"padding:6px;text-align:right;\">${fmtInt(r.total)}</td><td style=\"padding:6px;text-align:right;\">${fmtUsd(r.usd)}</td>`;tbody.appendChild(tr);}const tr=document.createElement('tr');tr.innerHTML=`<td colspan=\"2\" style=\"padding:6px;text-align:right;border-top:1px solid #243244;\"><strong>Total</strong></td><td style=\"padding:6px;text-align:right;border-top:1px solid #243244;\"><strong>${fmtInt(tot.totalPrompt)}</strong></td><td style=\"padding:6px;text-align:right;border-top:1px solid #243244;\"><strong>${fmtInt(tot.totalComp)}</strong></td><td style=\"padding:6px;text-align:right;border-top:1px solid #243244;\"><strong>${fmtInt(tot.totalPrompt+tot.totalComp)}</strong></td><td style=\"padding:6px;text-align:right;border-top:1px solid #243244;\"><strong>${fmtUsd(tot.totalUsd)}</strong></td>`;tbody.appendChild(tr);}fill('costTableBaseline',baseAgg.rows,baseAgg);fill('costTableCanary',canAgg.rows,canAgg);costLegend.textContent='Stacked tokens + $ line (canary)';}
      function getSloTarget(){const sel=sloTargetSelect.value;if(sel==='custom'){const v=Number(sloTargetCustom.value);return (!isNaN(v)&&v>0&&v<1)?v:0.995;}return Number(sel);}
  async function updateEnhancements(){try{const abs=absoluteRange();const win=getWindow();const now=Date.now();const from=abs?abs.from:(now-win*60000),to=abs?abs.to:now;const epSel=document.getElementById('endpointFilter').value;const traces=await fetchAllTracesForRange(epSel,from,to,500,30);const mode=cmpSelect.value; if(mode==='baseline'){const base=loadCohort('obsBaseline');const can=loadCohort('obsCanary');if(base&&can){const baseTr=await fetchAllTracesForRange(base.endpoint,base.from,base.to,500,30);const canTr=await fetchAllTracesForRange(can.endpoint,can.from,can.to,500,30);const b= bucketize(baseTr,base.from,base.to,60,[]).series;const c= bucketize(canTr,can.from,can.to,60,[]).series;const target=getSloTarget();const sliB=computeSLI(b);const sliC=computeSLI(c);const ebr=clamp01((target-(1-sliC.sli))/target);sliValue.textContent=fmtPct(sliC.sli);const delta=((sliC.sli-sliB.sli)*100).toFixed(2);sliMeta.textContent=`baseline ${fmtPct(sliB.sli)} • canary ${fmtPct(sliC.sli)} • Δ ${delta}pp`;ebrValue.textContent=fmtPct(ebr);ebrBar.style.width=(ebr*100).toFixed(1)+'%';ebrBar.style.background=ebr>=0.5?'#34d399':(ebr>=0.2?'#f59e0b':'#fb7185');ebrMeta.textContent=`spent ${fmtPct(1-ebr)}`;const merged=[];const len=c[0]?.points?.length||0;for(let i=0;i<len;i++){let ok=0,total=0;c.forEach(s=>{ok+=s.points[i].ok;total+=s.points[i].count;});merged.push({ok,total});}drawBurnLabeled(burnRateSpark.getContext('2d'),merged,target);const incidents=await fetchIncidents(can.from,can.to);latencyLegend.textContent='Baseline vs Canary (p50 / p95)';const lines=[];if(b.length) lines.push(b[0]);if(c.length) lines.push(c[0]);drawLatency(latencyTimeseries.getContext('2d'),lines,incidents);drawHeatLatency(latencyHeatmap.getContext('2d'),c.length?[c[0]]:[]);drawHeatErrors(errorHeatmap.getContext('2d'),c.length?[c[0]]:[]);drawTokens(tokensArea.getContext('2d'),c.length?[c[0]]:[]);const modelForPricing=canTr.find(t=>t.model)?.model||'default';drawCost(costLine.getContext('2d'),c.length?[c[0]]:[],modelForPricing);populateCostCompare(baseTr,canTr);return;}else{latencyLegend.textContent='Save Baseline and Canary to compare';populateCostTable(traces);}}
        populateCompareValues(traces);const groupBy = mode==='model'?['model'] : mode==='region'?['region'] : [];
        const {step,series}=bucketize(traces,from,to,60,groupBy);const target=getSloTarget();const sli=computeSLI(series);const ebr=clamp01((target-(1-sli.sli))/target);sliValue.textContent=fmtPct(sli.sli);sliMeta.textContent=`target ${fmtPct(target)} • ok=${sli.ok}/${sli.total}`;ebrValue.textContent=fmtPct(ebr);ebrBar.style.width=(ebr*100).toFixed(1)+'%';ebrBar.style.background=ebr>=0.5?'#34d399':(ebr>=0.2?'#f59e0b':'#fb7185');ebrMeta.textContent=`spent ${fmtPct(1-ebr)}`;const merged=[];const len=series[0]?.points?.length||0;for(let i=0;i<len;i++){let ok=0,total=0;series.forEach(s=>{ok+=s.points[i].ok;total+=s.points[i].count;});merged.push({ok,total});}
  drawBurnLabeled(burnRateSpark.getContext('2d'),merged,target);const incidents=await fetchIncidents(from,to);drawLatency(latencyTimeseries.getContext('2d'),series,incidents);drawHeatLatency(latencyHeatmap.getContext('2d'),series.length? [series[0]]:[]);drawHeatErrors(errorHeatmap.getContext('2d'),series.length? [series[0]]:[]);drawTokens(tokensArea.getContext('2d'),series.length? [series[0]]:[]);const modelForPricing=(mode==='model'&&cmpValues.selectedOptions[0]?.value)||traces.find(t=>t.model)?.model||'default';drawCost(costLine.getContext('2d'),series.length? [series[0]]:[],modelForPricing);populateCostTable(traces);}catch(e){console.error('enhancements update failed',e);}}
      function onCmpMode(){const v=cmpSelect.value;cmpValuesContainer.style.display=(v==='model'||v==='region')?'inline-flex':'none';baselineCanaryControls.style.display=(v==='baseline')?'inline-flex':'none';updateEnhancements();}
  cmpSelect.addEventListener('change',onCmpMode);cmpValues.addEventListener('change',()=>updateEnhancements());sloTargetSelect.addEventListener('change',()=>{sloTargetCustom.style.display=sloTargetSelect.value==='custom'?'inline-block':'none';updateEnhancements();});sloTargetCustom.addEventListener('change',()=>updateEnhancements());toggleIncidents.addEventListener('change',()=>updateEnhancements());
  document.getElementById('saveBaselineBtn').addEventListener('click',()=>{saveCohort('obsBaseline');updateEnhancements();});
  document.getElementById('saveCanaryBtn').addEventListener('click',()=>{saveCohort('obsCanary');updateEnhancements();});
  enableHoverLatency();enableHoverBurn();enableHoverTokens();enableHoverCost();
  // Realtime updates via SSE (optional, falls back silently if blocked)
  try {
    const live = document.createElement('span');
    live.id = 'liveIndicator';
    live.className = 'muted';
    live.style.marginLeft = '8px';
    live.style.fontSize = '11px';
    document.getElementById('lastRefresh').after(live);
    if ('EventSource' in window) {
      const es = new EventSource('/events');
      let last = 0;
      es.addEventListener('hello', ()=>{ live.textContent = 'live'; });
      es.addEventListener('ping', ()=>{ /* keepalive */ });
      es.addEventListener('trace', ()=>{
        const now = Date.now();
        if (now - last > 1500) { // throttle UI work
          last = now;
          load(false); // refresh without resetting cursor
        }
        live.textContent = 'live •';
        setTimeout(()=>{ live.textContent = 'live'; }, 1000);
      });
      es.onerror = ()=>{ live.textContent = ''; es.close(); };
    }
  } catch(_){}
  // Initialize custom range toggle (default off) and persist
  try{
    const chk=document.getElementById('useCustomRange');
    if(chk){
      const saved=localStorage.getItem('obs_use_custom_range');
      chk.checked = saved==='1' ? true : false;
      chk.addEventListener('change',()=>{
        try{ localStorage.setItem('obs_use_custom_range', chk.checked?'1':'0'); }catch(_){}
      });
    }
  }catch(_){ }
  updateRangeInputsEnabled();
  syncPresetToRange();load(true);setInterval(()=>{load(false);updateEnhancements();const chatVisible=document.getElementById('chatContainer').style.display!=='none'; if(chatVisible) refreshChatLogs();},15000);updateEnhancements();

  // === Synthetic Edit & Run Detail Modals ===
  const editModal=document.createElement('div');
  editModal.id='synthEditModal';
  editModal.style.cssText='display:none;position:fixed;inset:0;background:rgba(0,0,0,0.65);z-index:9999;align-items:center;justify-content:center';
  editModal.innerHTML=`<div style="background:#0b0f14;border:1px solid #243244;border-radius:10px;padding:14px;width:min(760px,94vw);max-height:90vh;overflow:auto;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
      <div style="font-weight:600;">Edit Synthetic Monitor</div>
      <button class="btn" id="synthEditClose" type="button">Close</button>
    </div>
    <div id="synthEditMeta" class="muted" style="font-size:12px;margin-bottom:6px;"></div>
    <div style="display:flex; gap:10px; align-items:stretch;">
      <div style="flex:1; min-width:260px; display:flex; flex-direction:column;">
        <div id="synthEditSteps" style="margin-top:6px; border:1px solid #243244; border-radius:6px; padding:6px; max-height:260px; overflow:auto; font-size:12px;"></div>
      </div>
      <div style="flex:1; min-width:260px; display:flex; flex-direction:column;">
        <div style="display:flex;align-items:center;justify-content:space-between;font-size:11px;margin-top:6px;">
          <span class="muted">Live JSON (read-only)</span>
          <button class="btn" id="toggleRawSpec" type="button" style="font-size:10px;padding:4px 8px;">Edit Raw</button>
        </div>
        <textarea id="synthEditSpec" rows="16" style="width:100%;background:#111827;color:#e5e7eb;border:1px solid #243244;border-radius:6px;padding:8px;font-family:ui-monospace,monospace;font-size:11px;line-height:1.3;resize:vertical;"></textarea>
      </div>
    </div>
    <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; align-items:flex-end;">
      <label style="font-size:11px; display:flex; flex-direction:column; gap:2px;" class="muted">Action
        <select id="newStepAction" style="background:#111827;color:#e5e7eb;border:1px solid #243244;border-radius:4px;padding:4px;min-width:90px;">
          <option value="goto">goto</option>
          <option value="click">click</option>
          <option value="type">type</option>
          <option value="waitfor">waitfor</option>
          <option value="wait">wait</option>
          <option value="asserttextcontains">asserttextcontains</option>
        </select>
      </label>
      <label style="font-size:11px; display:flex; flex-direction:column; gap:2px;" class="muted">Selector/URL
        <input id="newStepTarget" type="text" placeholder="selector or url" style="background:#111827;color:#e5e7eb;border:1px solid #243244;border-radius:4px;padding:4px;min-width:150px;" />
      </label>
      <label style="font-size:11px; display:flex; flex-direction:column; gap:2px;" class="muted">Text/Value
        <input id="newStepText" type="text" placeholder="text/value" style="background:#111827;color:#e5e7eb;border:1px solid #243244;border-radius:4px;padding:4px;min-width:150px;" />
      </label>
      <label style="font-size:11px; display:flex; flex-direction:column; gap:2px;" class="muted">Extra JSON
        <input id="newStepExtra" type="text" placeholder='{"retryMs":3000}' style="background:#111827;color:#e5e7eb;border:1px solid #243244;border-radius:4px;padding:4px;min-width:140px;" />
      </label>
      <button class="btn btn-accent" id="addStepBtn" type="button" style="align-self:flex-start;">Add Step</button>
  <button class="btn btn-accent" id="synthEditSave" type="button" style="align-self:flex-start;">Save</button>
      <button class="btn" id="synthEditDelete" type="button" style="background:#1f2937;border-color:#dc2626;color:#fca5a5;align-self:flex-start;">Delete</button>
      <span id="synthEditMsg" class="muted" style="font-size:12px;"></span>
    </div>
    <hr style="margin:14px 0;border:none;border-top:1px solid #1e293b;" />
    <div style="font-weight:600;margin-bottom:6px;">AI Assist Refine</div>
    <div style="font-size:11px;" class="muted">Enter a natural language change (e.g. "Add a wait step then assert the page contains 'ChatGPT'"). We will draft a new spec; you can merge or apply it.</div>
    <div style="display:flex;gap:6px;margin-top:6px;align-items:flex-start;">
      <textarea id="synthEditPrompt" rows="3" style="flex:1;background:#111827;color:#e5e7eb;border:1px solid #243244;border-radius:6px;padding:6px;font-family:ui-monospace,monospace;font-size:12px;" placeholder="Describe the change you want..."></textarea>
      <button class="btn" id="synthEditDraft" type="button">Draft</button>
    </div>
    <div id="synthDraftContainer" style="display:none;margin-top:10px;">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
        <div style="font-weight:600;">Draft Spec</div>
        <button class="btn" id="synthDraftMerge" type="button">Merge</button>
        <button class="btn" id="synthDraftReplace" type="button">Replace</button>
        <button class="btn" id="synthDraftDiscard" type="button">Discard</button>
      </div>
      <textarea id="synthDraftSpec" rows="10" style="width:100%;background:#111827;color:#e5e7eb;border:1px solid #243244;border-radius:6px;padding:8px;font-family:ui-monospace,monospace;font-size:12px;"></textarea>
      <div id="synthDraftSteps" style="margin-top:8px;font-size:11px;display:none;"></div>
      <div id="synthDiffPanel" style="display:none;margin-top:10px;">
        <div style="font-weight:600;margin-bottom:4px;display:flex;align-items:center;gap:8px;">Diff Preview <button class="btn" id="synthDiffHide" type="button">Hide</button></div>
        <pre id="synthDiffText" style="background:#111827;border:1px solid #243244;padding:8px;border-radius:6px;font-size:11px;white-space:pre-wrap;max-height:220px;overflow:auto;"></pre>
      </div>
    </div>
  </div>`;
  document.body.appendChild(editModal);
  function closeEdit(){editModal.style.display='none';}
  editModal.addEventListener('click',e=>{if(e.target===editModal) closeEdit();});
  editModal.querySelector('#synthEditClose').addEventListener('click',closeEdit);
  let editingMonitorId=null;
  async function openEditMonitor(id){
    editingMonitorId=id;
    const meta=editModal.querySelector('#synthEditMeta');
    const box=editModal.querySelector('#synthEditSpec');
    meta.textContent='Loading…'; box.value=''; editModal.style.display='flex'; box.readOnly=true;
    try{
      const r=await fetch(`/synthetics/${id}`,{cache:'no-store'});
      if(!r.ok){ meta.textContent='Fetch failed '+r.status; return; }
      const j=await r.json();
      meta.textContent=`Monitor #${j.id} • created ${j.createdAt?new Date(j.createdAt).toLocaleString():''}`;
      box.value=JSON.stringify(j.spec, null, 2);
      currentEditSpec = j.spec;
      ensureEditSpecIds();
      renderEditSteps();
      refreshEditJson();
    }catch(_){ meta.textContent='Error loading spec'; }
  }
  // Step-based editing state/helpers
  let currentEditSpec=null;
  function ensureEditSpecIds(){
    if(!currentEditSpec) return; if(!Array.isArray(currentEditSpec.steps)) currentEditSpec.steps=[];
    for(const s of currentEditSpec.steps){ if(!s.id) s.id=Math.random().toString(36).slice(2,10); }
  }
  function renderEditSteps(){
    const c=document.getElementById('synthEditSteps'); if(!c||!currentEditSpec) return;
    const steps=currentEditSpec.steps||[]; if(!steps.length){ c.innerHTML='<div class="muted" style="font-size:11px;">No steps yet.</div>'; return; }
    c.innerHTML=`<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;flex-wrap:wrap;">
      <button id="bulkDeleteSteps" class="btn" type="button" style="font-size:11px;padding:4px 8px;">Delete Selected</button>
      <button id="undoEditSteps" class="btn" type="button" style="font-size:11px;padding:4px 8px;">Undo</button>
      <span id="editValidationMsg" class="muted" style="font-size:10px;"></span>
    </div>` + steps.map((s,i)=>{
      const main = s.action==='goto'? (s.url||'') : (s.selector||'');
      const extraTxt = (s.action==='type'||s.action==='asserttextcontains') ? (s.text||'') : '';
      return `<div class="step-row" draggable="true" data-id="${s.id}" style="display:flex;align-items:center;gap:6px;padding:4px 2px;border-bottom:1px solid #1e293b;">
        <input data-f="sel" type="checkbox" style="margin:0 2px 0 0;" />
        <div class="drag-handle" title="Drag to reorder" style="cursor:grab;width:16px;color:#475569;">≡</div>
        <div style="width:22px;font-size:11px;color:#64748b;">${i+1}</div>
        <div style="flex:1; display:flex; flex-wrap:wrap; gap:4px; align-items:center;">
          <select data-f="action" style="background:#0f172a;color:#e5e7eb;border:1px solid #334155;border-radius:4px;font-size:11px;">
            ${['goto','click','type','waitfor','wait','asserttextcontains'].map(a=>`<option value="${a}" ${a===s.action?'selected':''}>${a}</option>`).join('')}
          </select>
          <input data-f="target" type="text" placeholder="selector/url" value="${escapeAttr(main)}" style="background:#0f172a;color:#e5e7eb;border:1px solid #334155;border-radius:4px;font-size:11px;padding:2px 4px;min-width:140px;" />
          <input data-f="text" type="text" placeholder="text/value" value="${escapeAttr(extraTxt)}" style="background:#0f172a;color:#e5e7eb;border:1px solid #334155;border-radius:4px;font-size:11px;padding:2px 4px;min-width:120px;${(s.action==='type'||s.action==='asserttextcontains')?'':'display:none;'}" />
          <input data-f="ms" type="number" placeholder="ms" value="${s.action==='wait' && s.ms? s.ms: ''}" style="background:#0f172a;color:#e5e7eb;border:1px solid #334155;border-radius:4px;font-size:11px;padding:2px 4px;width:70px;${s.action==='wait'?'':'display:none;'}" />
          <button data-step="${s.id}" class="btn btn-sm" style="background:#1e293b;border-color:#334155;font-size:10px;padding:4px 6px;">Delete</button>
        </div>
        <span class="muted" style="font-size:9px;">#${s.id}</span>
      </div>`;
    }).join('');
    // Delete handlers
    c.querySelectorAll('button[data-step]').forEach(btn=> btn.addEventListener('click', async e=>{
      const sid=btn.getAttribute('data-step');
      if(!confirm('Delete step '+sid+'?')) return;
  try{ const r=await fetch(`/synthetics/${editingMonitorId}/steps/${sid}`,{method:'DELETE'}); if(r.ok){ currentEditSpec.steps=currentEditSpec.steps.filter(x=>x.id!==sid); renderEditSteps(); refreshEditJson(); } }catch(_){ }
    }));
    // Field change handlers
    c.querySelectorAll('.step-row').forEach(row=>{
      const sid=row.getAttribute('data-id');
      const select=row.querySelector('select[data-f="action"]');
      const target=row.querySelector('input[data-f="target"]');
      const text=row.querySelector('input[data-f="text"]');
      const ms=row.querySelector('input[data-f="ms"]');
      const sel=row.querySelector('input[data-f="sel"]');
      function syncVisibility(){
        const act=select.value;
        if(act==='goto'){ target.placeholder='url'; }
        else{ target.placeholder='selector'; }
        text.style.display = (act==='type'||act==='asserttextcontains') ? '' : 'none';
        ms.style.display = act==='wait' ? '' : 'none';
        validateRow();
      }
  select.addEventListener('change',()=>{ updateStep(); syncVisibility(); });
  target.addEventListener('input',updateStep);
  text.addEventListener('input',updateStep);
  ms.addEventListener('input',updateStep);
      function updateStep(){
        const s = currentEditSpec.steps.find(x=>x.id===sid); if(!s) return;
        s.action=select.value;
        delete s.url; delete s.selector; delete s.text; delete s.ms;
        const val=target.value.trim(); if(s.action==='goto') s.url=val; else if(val) s.selector=val;
        if((s.action==='type'||s.action==='asserttextcontains') && text.value.trim()) s.text=text.value.trim();
        if(s.action==='wait'){ const n=parseInt(ms.value,10); if(!isNaN(n)&&n>0) s.ms=n; }
        pushUndo();
        validateAll();
      }
      function validateRow(){
        const act=select.value; const val=target.value.trim(); let bad=false;
        if(act==='goto' && !/^https?:\/\//i.test(val)) bad=true;
        if((act==='click'||act==='type'||act==='waitfor') && !val) bad=true;
        if(act==='wait' && (!ms.value || parseInt(ms.value,10)<=0)) bad=true;
  row.style.background = bad ? 'rgba(220,38,38,0.15)' : '';
        return !bad;
      }
      function validateAll(){
        const msgEl=document.getElementById('editValidationMsg');
        const rows=[...document.querySelectorAll('#synthEditSteps .step-row')];
        const invalid=rows.filter(r=> r.style.background.includes('38,38,38')).length; // crude
        msgEl.textContent = invalid? `${invalid} invalid step(s)` : '';
      }
      syncVisibility();
      // Drag and drop events per row
      row.addEventListener('dragstart',e=>{ dragId=row.getAttribute('data-id'); e.dataTransfer.effectAllowed='move'; });
      row.addEventListener('dragover',e=>{ e.preventDefault(); row.style.background='#162132'; });
      row.addEventListener('dragleave',()=>{ row.style.background=''; });
      row.addEventListener('drop',async e=>{ e.preventDefault(); row.style.background=''; const targetId=row.getAttribute('data-id'); if(!dragId||dragId===targetId) return; reorderSteps(dragId,targetId); dragId=null; });
      row.addEventListener('dragend',()=>{ dragId=null; c.querySelectorAll('.step-row').forEach(r=> r.style.background=''); });
    });
    // Bulk delete
    const delBtn=document.getElementById('bulkDeleteSteps'); if(delBtn){ delBtn.onclick=async ()=>{
      const ids=[...c.querySelectorAll('.step-row input[data-f="sel"]:checked')].map(x=> x.closest('.step-row').getAttribute('data-id'));
      if(!ids.length) return; if(!confirm('Delete '+ids.length+' steps?')) return;
  for(const id of ids){ try{ await fetch(`/synthetics/${editingMonitorId}/steps/${id}`,{method:'DELETE'}); }catch(_){} }
  currentEditSpec.steps=currentEditSpec.steps.filter(s=> !ids.includes(s.id));
  pushUndo();
  renderEditSteps();
  refreshEditJson();
    }; }
    // Undo button
    const undoBtn=document.getElementById('undoEditSteps'); if(undoBtn){ undoBtn.onclick=()=>{ doUndo(); }; }
  }
  // Undo stack
  const undoStack=[]; function pushUndo(){ try{ undoStack.push(JSON.stringify(currentEditSpec.steps)); if(undoStack.length>25) undoStack.shift(); }catch(_){ } }
  function doUndo(){ if(!undoStack.length) return; const prev=undoStack.pop(); try{ currentEditSpec.steps=JSON.parse(prev); renderEditSteps(); }catch(_){ } }
  // drag state
  let dragId=null;
  async function reorderSteps(srcId,dstId){
    const arr=currentEditSpec.steps.slice();
    const srcIdx=arr.findIndex(s=>s.id===srcId); const dstIdx=arr.findIndex(s=>s.id===dstId);
    if(srcIdx===-1||dstIdx===-1) return;
    const [m]=arr.splice(srcIdx,1); arr.splice(dstIdx,0,m);
    try{ const r=await fetch(`/synthetics/${editingMonitorId}/steps/reorder`,{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({ order: arr.map(s=>s.id) })}); if(r.ok){ currentEditSpec.steps=arr; renderEditSteps(); } }catch(_){ }
  }
  function escapeHtml(s){ return s.replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
  function escapeAttr(s){ return escapeHtml(String(s||'')).replace(/"/g,'&quot;'); }
  document.getElementById('addStepBtn').addEventListener('click', async ()=>{
    if(!editingMonitorId) return; ensureEditSpecIds();
    const action=document.getElementById('newStepAction').value;
    const target=document.getElementById('newStepTarget').value.trim();
    const text=document.getElementById('newStepText').value.trim();
    const extraRaw=document.getElementById('newStepExtra').value.trim();
    const step={ action };
    if(action==='goto') step.url=target; else if(target) step.selector=target;
    if(text && (action==='type'||action==='asserttextcontains')) step.text=text;
    if(action==='wait'){ const ms=parseInt(target||'0',10); if(ms>0) step.ms=ms; }
    if(extraRaw){ try{ const ex=JSON.parse(extraRaw); Object.assign(step, ex); }catch(_){ alert('Invalid Extra JSON'); return; } }
    try{
      const r=await fetch(`/synthetics/${editingMonitorId}/steps`,{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({ step })});
  const j=await r.json(); if(r.ok){ currentEditSpec.steps=j.steps; renderEditSteps(); refreshEditJson(); document.getElementById('newStepTarget').value=''; document.getElementById('newStepText').value=''; document.getElementById('newStepExtra').value=''; }
    }catch(_){ }
  });
  document.getElementById('toggleRawSpec').addEventListener('click',()=>{
    const box=document.getElementById('synthEditSpec');
    if(box.readOnly){ box.readOnly=false; box.style.opacity='1'; }
    else {
      try{ currentEditSpec=JSON.parse(box.value); ensureEditSpecIds(); renderEditSteps(); }catch(_){ alert('Invalid JSON'); return; }
      box.readOnly=true; refreshEditJson();
    }
  });
  function refreshEditJson(){ const box=document.getElementById('synthEditSpec'); if(!box.readOnly) return; try{ box.value=JSON.stringify(currentEditSpec,null,2); }catch(_){ } }
  function flushInlineEdits(){
    if(!currentEditSpec) return; const rows=[...document.querySelectorAll('#synthEditSteps .step-row')];
    const byId=new Map(currentEditSpec.steps.map(s=>[s.id,s]));
    for(const row of rows){
      const sid=row.getAttribute('data-id'); const s=byId.get(sid); if(!s) continue;
      const act=row.querySelector('select[data-f="action"]').value;
      const target=row.querySelector('input[data-f="target"]').value.trim();
      const text=row.querySelector('input[data-f="text"]').value.trim();
      const ms=row.querySelector('input[data-f="ms"]').value.trim();
      s.action=act; delete s.url; delete s.selector; delete s.text; delete s.ms;
      if(act==='goto') s.url=target; else if(target) s.selector=target;
      if((act==='type'||act==='asserttextcontains') && text) s.text=text;
      if(act==='wait'){ const n=parseInt(ms,10); if(!isNaN(n)&&n>0) s.ms=n; }
    }
  }
  async function saveEdit(){
    if(!editingMonitorId) return;
    const msg=document.getElementById('synthEditMsg');
    msg.textContent='Saving…';
    try{
  flushInlineEdits();
  const box=document.getElementById('synthEditSpec');
  let spec;
  // Always build from currentEditSpec (represents latest inline edits). If raw editor in edit mode, merge its changes first.
  if(!box.readOnly){ try { currentEditSpec = JSON.parse(box.value); ensureEditSpecIds(); } catch(_){ msg.textContent='Invalid JSON'; return; } }
  spec = currentEditSpec;
      const r=await fetch(`/synthetics/${editingMonitorId}`,{method:'PUT',headers:{'content-type':'application/json'},body:JSON.stringify({ spec })});
      const j=await r.json();
      if(!r.ok){ msg.textContent='Save failed: '+(j.error||r.status); return; }
      currentEditSpec = j.spec || spec;
      renderEditSteps(); refreshEditJson();
      msg.textContent='Saved'; setTimeout(()=>{msg.textContent='';},1200);
      loadSynthMonitors();
    }catch(_){ msg.textContent='Error'; }
  }
  editModal.querySelector('#synthEditSave').addEventListener('click',saveEdit);
  // Delete
  editModal.querySelector('#synthEditDelete').addEventListener('click', async ()=>{
    if(!editingMonitorId) return;
    if(!confirm('Delete this synthetic monitor and its runs?')) return;
    const msg=document.getElementById('synthEditMsg'); msg.textContent='Deleting…';
    try{ const r=await fetch(`/synthetics/${editingMonitorId}`,{method:'DELETE'}); if(!r.ok){ msg.textContent='Delete failed'; return; } msg.textContent='Deleted'; loadSynthMonitors(); closeEdit(); }catch(_){ msg.textContent='Error'; }
  });
  // AI Assist drafting
  const draftBtnId = '#synthEditDraft';
  editModal.querySelector(draftBtnId).addEventListener('click', async ()=>{
    const promptEl=document.getElementById('synthEditPrompt');
    const baseSpecEl=document.getElementById('synthEditSpec');
    const msg=document.getElementById('synthEditMsg');
    const prompt=promptEl.value.trim(); if(!prompt){ msg.textContent='Prompt empty'; return; }
    msg.textContent='Drafting…';
    try{
      const r=await fetch('/synthetics/draft',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({ prompt })});
      const j=await r.json();
      if(!r.ok){ msg.textContent='Draft failed'; return; }
      const draft=(j||{}).spec; if(!draft){ msg.textContent='No draft'; return; }
      document.getElementById('synthDraftContainer').style.display='block';
      document.getElementById('synthDraftSpec').value=JSON.stringify(draft,null,2);
      msg.textContent='Draft ready';
    }catch(_){ msg.textContent='Draft error'; }
  });
  function mergeSpecs(baseObj, draftObj){
    const merged = { ...baseObj, ...draftObj };
    const seen = new Set();
    const key = s=>`${s.action||''}::${s.selector||''}::${s.url||''}`;
    const steps=[];
    (baseObj.steps||[]).forEach(s=>{ const k=key(s); seen.add(k); steps.push(s); });
    (draftObj.steps||[]).forEach(s=>{ const k=key(s); if(!seen.has(k)){ seen.add(k); steps.push(s); } });
    merged.steps=steps;
    return merged;
  }
  function diffSpecs(oldSpec, newSpec){
    const o = JSON.stringify(oldSpec, null, 2).split(/\n/);
    const n = JSON.stringify(newSpec, null, 2).split(/\n/);
    const max = Math.max(o.length,n.length);
    const lines=[];
    for(let i=0;i<max;i++){
      const a=o[i]; const b=n[i];
      if(a===b) lines.push('  '+(a||''));
      else {
        if(a!==undefined) lines.push('- '+a);
        if(b!==undefined) lines.push('+ '+b);
      }
    }
    return lines.join('\n');
  }
  editModal.querySelector('#synthDraftMerge').addEventListener('click',()=>{
    try{
      const base=JSON.parse(document.getElementById('synthEditSpec').value);
      const draft=JSON.parse(document.getElementById('synthDraftSpec').value);
  const merged=mergeSpecs(base,draft);
  const diff=diffSpecs(base, merged);
  const box=document.getElementById('synthEditSpec');
  box.value=JSON.stringify(merged,null,2);
  // show diff inline in message temporarily
  const msg=document.getElementById('synthEditMsg');
  msg.textContent='Merged';
  const diffPanel=document.getElementById('synthDiffPanel');
  const diffText=document.getElementById('synthDiffText');
  if(diffPanel && diffText){ diffText.textContent=diff; diffPanel.style.display='block'; }
    }catch(_){ document.getElementById('synthEditMsg').textContent='Merge failed'; }
  });
  editModal.querySelector('#synthDraftReplace').addEventListener('click',()=>{
  try{ const draft=JSON.parse(document.getElementById('synthDraftSpec').value); const base=JSON.parse(document.getElementById('synthEditSpec').value); document.getElementById('synthEditSpec').value=JSON.stringify(draft,null,2); const diffPanel=document.getElementById('synthDiffPanel'); const diffText=document.getElementById('synthDiffText'); if(diffPanel&&diffText){ diffText.textContent=diffSpecs(base,draft); diffPanel.style.display='block'; } }catch(_){ document.getElementById('synthEditMsg').textContent='Replace failed'; }
  });
  editModal.querySelector('#synthDraftDiscard').addEventListener('click',()=>{
    document.getElementById('synthDraftContainer').style.display='none';
    document.getElementById('synthDraftSpec').value='';
    const diffPanel=document.getElementById('synthDiffPanel'); if(diffPanel) diffPanel.style.display='none';
    const stepsDiv=document.getElementById('synthDraftSteps'); if(stepsDiv) { stepsDiv.style.display='none'; stepsDiv.innerHTML=''; }
  });
  const diffHideBtn=()=>{ const diffPanel=document.getElementById('synthDiffPanel'); if(diffPanel) diffPanel.style.display='none'; };
  document.addEventListener('click',e=>{ if(e.target && e.target.id==='synthDiffHide') diffHideBtn(); });
  function renderDraftSteps(draft){
    const stepsDiv=document.getElementById('synthDraftSteps'); if(!stepsDiv) return;
    if(!draft || !Array.isArray(draft.steps)){ stepsDiv.style.display='none'; stepsDiv.innerHTML=''; return; }
    stepsDiv.style.display='block';
    const baseSpecText=document.getElementById('synthEditSpec').value;
    let baseSpec={}; try{ baseSpec=JSON.parse(baseSpecText);}catch(_){ }
    const existingKeys=new Set((baseSpec.steps||[]).map(s=>`${s.action||''}::${s.selector||''}::${s.url||''}`));
    stepsDiv.innerHTML='<div style="font-weight:600;margin-bottom:4px;">Select Draft Steps to Merge</div>';
    draft.steps.forEach((s,i)=>{
      const k=`${s.action||''}::${s.selector||''}::${s.url||''}`;
      const checked = !existingKeys.has(k);
      const row=document.createElement('label');
      row.style.cssText='display:flex;align-items:center;gap:6px;margin-bottom:2px;';
      row.innerHTML=`<input type='checkbox' data-draft-step='${i}' ${checked?'checked':''}/> <code style='font-size:11px;'>${s.action}${s.selector? ' '+s.selector: (s.url? ' '+s.url: '')}</code>`;
      stepsDiv.appendChild(row);
    });
    // Custom merge honoring selection
    const mergeBtn=document.createElement('button');
    mergeBtn.textContent='Merge Selected';
    mergeBtn.className='btn';
    mergeBtn.style.marginTop='4px';
    mergeBtn.addEventListener('click',()=>{
      try{
        const base=JSON.parse(document.getElementById('synthEditSpec').value);
        const selectedIdx=[...stepsDiv.querySelectorAll('input[data-draft-step]:checked')].map(x=>Number(x.getAttribute('data-draft-step')));
        const selectedSteps=(draft.steps||[]).filter((_,i)=>selectedIdx.includes(i));
        const merged={ ...base };
        merged.steps=[...(base.steps||[])];
        const seen=new Set((merged.steps||[]).map(s=>`${s.action||''}::${s.selector||''}::${s.url||''}`));
        selectedSteps.forEach(s=>{ const key=`${s.action||''}::${s.selector||''}::${s.url||''}`; if(!seen.has(key)){ seen.add(key); merged.steps.push(s); }});
        const diffPanel=document.getElementById('synthDiffPanel'); const diffText=document.getElementById('synthDiffText');
        const old=base; const newSpec=merged; document.getElementById('synthEditSpec').value=JSON.stringify(newSpec,null,2);
        if(diffPanel&&diffText){ diffText.textContent=diffSpecs(old,newSpec); diffPanel.style.display='block'; }
      }catch(_){ document.getElementById('synthEditMsg').textContent='Selective merge failed'; }
    });
    stepsDiv.appendChild(mergeBtn);
  }
  // Hook drafting to show step selection
  const draftBtn=document.getElementById('synthEditDraft');
  if(draftBtn){
    draftBtn.addEventListener('click',()=>{
      setTimeout(()=>{ try{ const d=JSON.parse(document.getElementById('synthDraftSpec').value); renderDraftSteps(d);}catch(_){ } },400);
    });
  }
  // Partial patch application: user selects subset of draft JSON lines starting with + or content
  // (Simplified approach: parse both and only carry over steps from draft not present in base)
  // Already covered by mergeSpecs; could extend later.

  // Run detail modal
  const runModal=document.createElement('div');
  runModal.id='synthRunModal';
  runModal.style.cssText='display:none;position:fixed;inset:0;background:rgba(0,0,0,0.65);z-index:9999;align-items:center;justify-content:center';
  runModal.innerHTML=`<div style="background:#0b0f14;border:1px solid #243244;border-radius:10px;padding:14px;width:min(720px,92vw);max-height:90vh;overflow:auto;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
      <div style="font-weight:600;">Run Details</div>
      <button class="btn" id="synthRunClose" type="button">Close</button>
    </div>
    <div id="synthRunMeta" class="muted" style="font-size:12px;margin-bottom:6px;"></div>
    <pre id="synthRunLogs" style="background:#111827;border:1px solid #243244;padding:8px;border-radius:6px;font-size:11px;white-space:pre-wrap;max-height:50vh;overflow:auto;">Loading…</pre>
    <div id="synthRunShot" style="margin-top:8px;"></div>
  </div>`;
  document.body.appendChild(runModal);
  function closeRun(){runModal.style.display='none';}
  runModal.addEventListener('click',e=>{if(e.target===runModal) closeRun();});
  runModal.querySelector('#synthRunClose').addEventListener('click',closeRun);
  function openRunDetail(data){
    runModal.style.display='flex';
    const meta=runModal.querySelector('#synthRunMeta');
    const logsEl=runModal.querySelector('#synthRunLogs');
    const shot=runModal.querySelector('#synthRunShot');
    meta.textContent=`Run #${data.id} • Monitor #${data.monitorId} • ${data.ok?'OK':'Fail '+(data.statusText||'')}`;
  const stepLines=(data.steps||[]).map((s,i)=>`#${i+1} ${s.action}${s.selector? ' '+s.selector: (s.url? ' '+s.url:'')} ${s.ok?'✓':'✗'} ${s.ms!=null? '('+s.ms+'ms)':''}${s.error? ' – '+s.error:''}`);
  const logLines=(data.logs||[]).map(l=>`${new Date(l.ts).toISOString()} ${l.msg}`);
  logsEl.textContent=[ 'Steps:', ...stepLines, '', 'Logs:', ...logLines ].join('\n') || '(no logs)';
    shot.innerHTML='';
    if(data.screenshot){ const img=document.createElement('img'); img.src=data.screenshot; img.alt='screenshot'; img.style.maxWidth='100%'; img.style.border='1px solid #243244'; img.style.borderRadius='6px'; shot.appendChild(img); }
  }
  window.openRunDetail=openRunDetail; // expose for earlier listeners
  window.openEditMonitor=openEditMonitor;
    </script>
  </body>
</html>
